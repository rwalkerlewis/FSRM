name: FSRM Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          g++ \
          gcc \
          gfortran \
          mpich \
          libmpich-dev \
          libhdf5-mpich-dev \
          petsc-dev \
          libpetsc-real-dev \
          pkg-config
    
    - name: Find and Set PETSc
      run: |
        echo "=== Searching for PETSc ===" 
        
        # Find PETSc directory
        if [ -d "/usr/lib/petscdir" ]; then
          PETSC_BASE=$(find /usr/lib/petscdir -maxdepth 1 -name "petsc-*" -type d 2>/dev/null | sort -V | tail -1)
          if [ -n "$PETSC_BASE" ]; then
            echo "Found PETSc base: $PETSC_BASE"
            export PETSC_DIR="$PETSC_BASE"
            echo "PETSC_DIR=$PETSC_BASE" >> $GITHUB_ENV
            
            # Find architecture subdirectory
            if [ -d "$PETSC_BASE" ]; then
              PETSC_ARCH_DIR=$(find "$PETSC_BASE" -maxdepth 1 -type d -name "*x86_64*" 2>/dev/null | head -1)
              if [ -n "$PETSC_ARCH_DIR" ]; then
                PETSC_ARCH=$(basename "$PETSC_ARCH_DIR")
                echo "Found PETSC_ARCH: $PETSC_ARCH"
                echo "PETSC_ARCH=$PETSC_ARCH" >> $GITHUB_ENV
                export PETSC_ARCH="$PETSC_ARCH"
              fi
            fi
            
            echo "PETSc configured:"
            echo "  PETSC_DIR=$PETSC_DIR"
            echo "  PETSC_ARCH=$PETSC_ARCH"
          fi
        fi
        
        # Also search for petsc.h and libpetsc
        echo "=== PETSc files ===" 
        find /usr -name "petsc.h" 2>/dev/null | head -3 || true
        find /usr -name "libpetsc.so*" 2>/dev/null | head -3 || true
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        CC=gcc CXX=g++ cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DENABLE_TESTING=ON \
          -DENABLE_CUDA=OFF \
          -DBUILD_EXAMPLES=ON \
          -DCMAKE_VERBOSE_MAKEFILE=ON
    
    - name: Build
      run: |
        cd build
        make -j$(nproc) VERBOSE=1
    
    - name: Verify Build
      run: |
        echo "=== Checking build artifacts ==="
        ls -lh build/fsrm || echo "fsrm not found"
        ls -lh build/libfsrmlib.so || echo "libfsrmlib.so not found"
        ls -lh build/tests/run_tests || echo "run_tests not found"
        
        if [ -f "build/fsrm" ] && [ -f "build/libfsrmlib.so" ]; then
          echo "✓ Build SUCCESS - all artifacts present"
        else
          echo "✗ Build FAILED - missing artifacts"
          exit 1
        fi
    
    - name: Run Tests
      working-directory: build
      run: |
        ctest --output-on-failure --verbose || true
    
    - name: Upload Build Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
          build/Testing/Temporary/LastTest.log
