# ==============================================================================
# Underground Nuclear Test (Low Yield, Shallow Burial) - CTBT / IMS-style
# ==============================================================================
# Purpose:
# - Quick-running "small shot" underground nuclear test scenario
# - Emphasizes higher-frequency seismic content (small yield, shallow burial)
# - Useful for discrimination / monitoring workflow demos
#
# Notes:
# - This config mirrors the structure of `underground_nuclear_test.config` but is
#   intentionally lighter-weight (smaller domain, shorter runtime, CPU-friendly).
# - Values are representative / educational, not a calibration to a specific test.
# ==============================================================================

[SIMULATION]
name = underground_nuclear_test_1kt_shallow
description = 1 kt shallow underground nuclear test for monitoring/discrimination examples

start_time = 0.0
end_time = 30.0

# Use a less aggressive timestep than the 150 kt case
dt_initial = 1.0e-5
dt_min = 1.0e-7
dt_max = 0.02
max_timesteps = 400000

adaptive_dt = true
cfl_number = 0.45

output_frequency = 200
output_format = HDF5
enable_checkpointing = true
checkpoint_frequency = 20000

# Physics (dry rock + elastodynamics + inelastic near-source behavior)
fluid_model = NONE
solid_model = ELASTOPLASTIC_DP
enable_geomechanics = true
enable_elastodynamics = true
enable_thermal = true
enable_fractures = true
enable_plasticity = true

# Numerics
use_discontinuous_galerkin = true
dg_order = 3
use_ader_time_integration = true
enable_local_time_stepping = true
lts_rate = 2

rtol = 1.0e-6
atol = 1.0e-9
max_nonlinear_iterations = 40

# Keep this runnable on machines without GPUs
use_gpu = false
gpu_mode = CPU_FALLBACK

# ==============================================================================
# Explosion Source
# ==============================================================================
[EXPLOSION_SOURCE]
type = NUCLEAR_UNDERGROUND

# Device parameters
yield_kt = 1.0
depth_of_burial = 200.0
location_x = 10000.0
location_y = 10000.0
location_z = -200.0

# Empirical cavity/damage scaling (small shot)
# Cavity radius ~ 55 * W^0.295  => ~ 55 m for 1 kt in granite
cavity_radius = 55.0
crushed_zone_radius = 140.0
fractured_zone_radius = 275.0
damaged_zone_radius = 550.0

source_model = MUELLER_MURPHY
corner_frequency_scaling = PATTON
source_time_function = NUCLEAR_EXPLOSION

# Faster source for small yield
rise_time = 0.01
overshoot_factor = 1.1

# Moment tensor decomposition (more isotropic for a well-contained shot)
isotropic_fraction = 0.80
clvd_fraction = 0.18
double_couple_fraction = 0.02

# Rough scalar moment for a 1 kt contained shot (order-of-magnitude)
scalar_moment = 1.0e15

enable_spall = true
spall_depth = 80.0
spall_velocity = 1.5

# ==============================================================================
# Grid (smaller domain than the 50 km reference)
# ==============================================================================
[GRID]
nx = 160
ny = 160
nz = 80

Lx = 20000.0
Ly = 20000.0
Lz = 10000.0

origin_x = 0.0
origin_y = 0.0
origin_z = 0.0

use_unstructured = false

[amr]
enabled = true
method = plex_refine

[amr.criterion]
type = feature
feature_type = explosion_source

[amr.limits]
max_refinement_level = 3
max_cells = 2000000
min_cell_size = 10.0

[amr.features]
buffer_layers = 2

[amr.features.explosion]
x = 10000.0
y = 10000.0
z = 200.0
radius = 1500.0
level = 3

# ==============================================================================
# Material Properties (granite-like host)
# ==============================================================================
[ROCK]
name = GRANITE_HOST
constitutive_model = ELASTOPLASTIC_DP

youngs_modulus = 55.0e9
poisson_ratio = 0.25
density = 2650.0

p_wave_velocity = 5500.0
s_wave_velocity = 3200.0

quality_factor_p = 600.0
quality_factor_s = 300.0

failure_criterion = DRUCKER_PRAGER
cohesion = 25.0e6
friction_angle = 35.0
dilation_angle = 10.0
tensile_strength = 10.0e6

damage_model = SCALAR_DAMAGE
initial_damage = 0.0
max_damage = 0.99
damage_evolution = STRAIN_BASED

porosity = 0.01
compressibility = 5.0e-11
permeability_x = 1.0e-18
permeability_y = 1.0e-18
permeability_z = 1.0e-18

thermal_conductivity = 2.5
specific_heat = 800.0
thermal_expansion = 8.0e-6

# ==============================================================================
# Initial Conditions
# ==============================================================================
[IC1]
field = DISPLACEMENT
distribution = UNIFORM
value = 0.0

[IC2]
field = VELOCITY
distribution = UNIFORM
value = 0.0

[IC3]
field = STRESS
distribution = LITHOSTATIC
surface_stress = 0.0
density = 2650.0
gravity = 9.81

[IC4]
field = TEMPERATURE
distribution = UNIFORM
value = 288.15

# ==============================================================================
# Boundary Conditions
# ==============================================================================
[BC1]
type = FREE_SURFACE
location = ZMIN
field = DISPLACEMENT

[BC2]
type = ABSORBING
location = XMIN, XMAX, YMIN, YMAX, ZMAX
field = DISPLACEMENT
absorbing_type = PML
pml_layers = 12
pml_strength = 80.0

# ==============================================================================
# Receivers (a simple IMS-style radial line + one borehole)
# ==============================================================================
[RECEIVERS]
output_format = HDF5
sampling_rate = 200.0
output_velocity = true
output_displacement = true

[RECEIVER_ARRAY_RADIAL]
type = LINE
start = 10000.0, 10000.0, 0.0
end = 19000.0, 10000.0, 0.0
num_stations = 16
fields = displacement, velocity, acceleration

[RECEIVER_BOREHOLE]
name = BH_300M
location = 12000.0, 10000.0, 300.0
fields = displacement, velocity

# ==============================================================================
# Output
# ==============================================================================
[OUTPUT]
format = HDF5
path = output/underground_nuclear_1kt_shallow

save_displacement = true
save_velocity = true
save_stress = true
save_damage = true
save_temperature = true

volume_output_frequency = 1000
surface_output = true
surface_output_frequency = 200

[ANALYSIS]
compute_seismic_moment = true
compute_magnitude = true
magnitude_type = mb, Mw
compute_ms_mb_ratio = true
compute_damage_volume = true
damage_threshold = 0.1

