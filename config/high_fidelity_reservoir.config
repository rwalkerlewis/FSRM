# =============================================================================
# High-Fidelity Coupled Reservoir Simulation Configuration
# =============================================================================
# 
# This configuration demonstrates the advanced high-fidelity options for
# coupled fluid flow and geomechanics simulation. These options provide
# enhanced physical accuracy at the cost of additional computation.
#
# The high-fidelity modules extend (not replace) the basic capabilities.
# Enable only the features needed for your specific problem.
#
# Documentation: docs/high_fidelity_physics.md
# =============================================================================

[simulation]
name = "High-Fidelity Coupled Reservoir"
description = "CO2 injection into fractured carbonate with full THM coupling"

# Time parameters
start_time = 0.0
end_time = 31536000.0          # 1 year in seconds
dt_initial = 3600.0            # 1 hour
dt_min = 1.0
dt_max = 86400.0               # 1 day
max_timesteps = 100000
output_frequency = 24          # Every 24 timesteps (daily with hourly dt)

# Output
output_format = VTK
output_file = output/high_fidelity_reservoir

# Solver settings
rtol = 1e-6
atol = 1e-8
max_nonlinear_iterations = 30
max_linear_iterations = 2000

# =============================================================================
[grid]
# =============================================================================
nx = 50
ny = 50
nz = 20
Lx = 1000.0                    # 1 km x 1 km x 200 m domain
Ly = 1000.0
Lz = 200.0
origin_x = 0.0
origin_y = 0.0
origin_z = -3000.0             # 3 km depth

# =============================================================================
[material]
# =============================================================================
# Base rock properties
porosity = 0.15
permeability_x = 50e-15        # 50 mD
permeability_y = 50e-15
permeability_z = 5e-15         # 10:1 anisotropy
compressibility = 5e-10

# Mechanical properties
youngs_modulus = 25e9          # 25 GPa
poisson_ratio = 0.25
density = 2600.0
biot_coefficient = 0.8

# Thermal properties
thermal_conductivity = 2.5
heat_capacity = 900.0
thermal_expansion = 1e-5

# Wave propagation (for dynamic events)
p_wave_velocity = 4500.0
s_wave_velocity = 2600.0
quality_factor = 100.0

# =============================================================================
[fluid]
# =============================================================================
# CO2 injection scenario - use compositional for accurate phase behavior
fluid_model = COMPOSITIONAL

# Reference properties
density = 800.0                # CO2 at reservoir conditions
viscosity = 5e-5               # CO2 viscosity
compressibility = 1e-8

# Two-phase properties
oil_density_std = 850.0
water_density_std = 1050.0     # Formation brine
oil_viscosity = 0.003
water_viscosity = 0.0008

# Relative permeability
residual_saturation = 0.25
water_residual_saturation = 0.20
corey_exponent_oil = 3.0
corey_exponent_water = 4.0

# Reservoir conditions
reservoir_temperature = 373.15 # 100°C

# =============================================================================
[wells]
# =============================================================================
# CO2 Injector
well_1_name = INJ1
well_1_type = INJECTOR
well_1_x = 500.0
well_1_y = 500.0
well_1_z = -3100.0
well_1_rate = 0.1              # 0.1 m³/s (~8600 m³/day)
well_1_bhp_limit = 60e6        # 60 MPa max BHP

# Observation well
well_2_name = OBS1
well_2_type = OBSERVATION
well_2_x = 700.0
well_2_y = 500.0
well_2_z = -3100.0

# =============================================================================
# HIGH-FIDELITY FLUID FLOW OPTIONS
# =============================================================================
[high_fidelity_flow]
# Master switch
enable_high_fidelity_flow = true

# -----------------------------------------------------------------------------
# Non-Darcy Flow (important near wellbore at high rates)
# -----------------------------------------------------------------------------
enable_non_darcy_flow = true
forchheimer_beta = 5e4         # Non-Darcy coefficient
beta_correlation = geertsma    # Options: constant, cooke, geertsma, frederick_graves
critical_reynolds = 10.0       # Above this, non-Darcy significant

# -----------------------------------------------------------------------------
# Dual-Porosity Model (for naturally fractured carbonate)
# -----------------------------------------------------------------------------
enable_dual_porosity = true
enable_dual_permeability = true # Allow matrix-matrix flow

# Matrix continuum (low perm storage)
matrix_porosity = 0.12
matrix_permeability = 1e-17    # 0.01 mD
matrix_compressibility = 5e-10
matrix_block_size = 2.0        # 2 m block size

# Fracture continuum (high perm flow)
fracture_porosity = 0.03
fracture_permeability = 1e-13  # 100 mD
fracture_compressibility = 1e-8
fracture_spacing = 2.0

# Shape factor model
shape_factor_model = kazemi    # Options: kazemi, coats, gilman, lemonnier
shape_factor_multiplier = 1.0
include_gravity_transfer = true
include_capillary_transfer = true

# -----------------------------------------------------------------------------
# Non-Isothermal Flow (thermal effects on CO2 properties)
# -----------------------------------------------------------------------------
enable_non_isothermal_flow = true
include_conduction = true
include_convection = true
include_phase_change = true    # CO2 can change phase
include_joule_thomson = true   # J-T cooling during expansion

# Thermal properties
rock_thermal_conductivity = 2.5
rock_specific_heat = 900.0
rock_density = 2600.0
water_thermal_conductivity = 0.6
water_specific_heat = 4186.0
co2_thermal_conductivity = 0.02
co2_specific_heat = 2000.0

reference_temperature = 373.15
latent_heat_vaporization = 2.26e6

# -----------------------------------------------------------------------------
# Miscible Flow (CO2 dissolves in oil)
# -----------------------------------------------------------------------------
enable_miscible_flow = true
minimum_miscibility_pressure = 18e6  # MMP for this CO2-oil system
miscibility_transition_width = 3e6
todd_longstaff_omega = 0.67
longitudinal_dispersivity = 0.5
transverse_dispersivity = 0.05
molecular_diffusion = 1e-9

# -----------------------------------------------------------------------------
# Dynamic Relative Permeability
# -----------------------------------------------------------------------------
enable_dynamic_relperm = true
include_capillary_number = true
critical_capillary_number = 1e-5
Sor_at_high_Ca = 0.05
include_fingering = true
fingering_exponent = 0.5
mobility_ratio_threshold = 10.0

# =============================================================================
# HIGH-FIDELITY GEOMECHANICS OPTIONS
# =============================================================================
[high_fidelity_geomechanics]
# Master switch
enable_high_fidelity_geomech = true

# -----------------------------------------------------------------------------
# Viscoplasticity (rate effects during injection)
# -----------------------------------------------------------------------------
enable_viscoplasticity = true
viscoplastic_model = perzyna   # Options: perzyna, duvaut_lions
viscoplastic_fluidity = 1e-7
viscoplastic_reference_stress = 50e6
viscoplastic_exponent = 3.0

yield_criterion = drucker_prager
friction_angle = 35.0          # degrees
cohesion = 5e6                 # 5 MPa
dilation_angle = 10.0          # degrees

# -----------------------------------------------------------------------------
# Creep (long-term deformation)
# -----------------------------------------------------------------------------
enable_creep = true
creep_model = power_law        # Options: power_law, norton, lemaitre, burgers
creep_coefficient_A = 1e-28
creep_stress_exponent = 3.5
creep_activation_energy = 50e3 # J/mol
creep_reference_temperature = 373.15

include_primary_creep = true
primary_exponent = 0.33
include_tertiary_creep = false # Not expected for this scenario

# -----------------------------------------------------------------------------
# Gradient-Enhanced Damage (for localization regularization)
# -----------------------------------------------------------------------------
enable_gradient_damage = false # Enable if expecting brittle failure
characteristic_length = 0.5    # m (related to mesh size)
damage_threshold = 1e-4
fracture_energy = 100.0        # J/m²

# =============================================================================
# ADVANCED COUPLED PHYSICS
# =============================================================================
[advanced_coupling]
# Master switch
enable_advanced_coupling = true

# -----------------------------------------------------------------------------
# Full Biot Dynamics (for wave effects during injection transients)
# -----------------------------------------------------------------------------
enable_full_biot_dynamics = false  # Enable for dynamic events
biot_formulation = u_p         # Options: u_p, u_w, u_p_w
biot_high_frequency = true
biot_tortuosity = 2.0

# -----------------------------------------------------------------------------
# THM Coupling (Thermo-Hydro-Mechanical)
# -----------------------------------------------------------------------------
enable_thm_coupling = true
thm_coupling_type = iterative  # Options: sequential, iterative, monolithic
max_coupling_iterations = 15
coupling_tolerance = 1e-5
relaxation_factor = 0.8        # Under-relaxation for stability

# T -> M coupling
thermal_expansion_solid = 1e-5
thermal_softening_modulus = -1e6  # dE/dT (negative = softening)

# T -> H coupling
thermal_expansion_fluid = 2e-4
viscosity_temperature_coeff = 0.02

# H -> M coupling (Biot)
# Uses biot_coefficient from [material]

# M -> H coupling
storage_compression_coefficient = 1e-9
stress_dependent_permeability = true
permeability_stress_coefficient = 5e-8
permeability_strain_coefficient = 3.0  # Kozeny-Carman exponent

# M -> T coupling
include_plastic_heating = true
taylor_quinney_coefficient = 0.9

# Thermal pressurization
thermal_pressurization_coeff = 0.08e6  # Pa/K

# -----------------------------------------------------------------------------
# Multi-Scale Coupling (if heterogeneity important)
# -----------------------------------------------------------------------------
enable_multiscale_coupling = false  # Enable for complex heterogeneity
multiscale_method = asymptotic # Options: fe2, hmm, asymptotic
rve_size_x = 0.01
rve_size_y = 0.01
rve_size_z = 0.01

# =============================================================================
# HIGH-FIDELITY NUMERICS
# =============================================================================
[high_fidelity_numerics]
# Master switch
enable_high_fidelity_numerics = true

# -----------------------------------------------------------------------------
# SUPG Stabilization (for advection-dominated transport)
# -----------------------------------------------------------------------------
enable_supg_stabilization = true
stabilization_method = SUPG    # Options: SUPG, GLS, VMS
tau_formula = shakib           # Options: shakib, tezduyar, codina
tau_multiplier = 1.0
include_transient_tau = true
shock_capturing = true
shock_capture_coeff = 0.3

# -----------------------------------------------------------------------------
# Advanced Time Integration
# -----------------------------------------------------------------------------
enable_advanced_time_integration = true
time_scheme = generalized_alpha  # Options: backward_euler, newmark, generalized_alpha, bdf2
generalized_alpha_rho = 0.3    # ρ_∞ (0 = max damping, 1 = no damping)

# Adaptive time stepping
adaptive_timestepping = true
error_tolerance = 1e-4
safety_factor = 0.9
min_dt_factor = 0.1
max_dt_factor = 3.0

# -----------------------------------------------------------------------------
# Adaptive Mesh Refinement
# -----------------------------------------------------------------------------
enable_amr = true
refinement_indicator = gradient  # Options: gradient, residual, recovery, goal_oriented
refinement_strategy = fixed_fraction
refine_fraction = 0.2
coarsen_fraction = 0.05
max_refinement_level = 3
min_element_size = 5.0         # meters

# Refinement near wells and fronts
physics_based_refinement = true
pressure_gradient_threshold = 1e4  # Pa/m
saturation_gradient_threshold = 0.1

# -----------------------------------------------------------------------------
# Physics-Based Preconditioning
# -----------------------------------------------------------------------------
enable_physics_preconditioner = true
preconditioner_type = field_split  # Options: block_jacobi, block_gauss_seidel, field_split
field_split_type = multiplicative  # Options: additive, multiplicative

# Block structure (flow, mechanics, thermal)
block_0_name = pressure
block_0_solver = gamg          # Algebraic multigrid for pressure
block_1_name = displacement
block_1_solver = gamg
block_2_name = temperature
block_2_solver = jacobi

# =============================================================================
# INITIAL CONDITIONS
# =============================================================================
[initial_conditions]
pressure = 45e6                # 45 MPa at 3 km
temperature = 373.15           # 100°C geothermal
saturation_water = 1.0         # Initially water-saturated
saturation_co2 = 0.0

# Initial stress state (compressive positive)
stress_xx = -70e6              # Horizontal stress
stress_yy = -70e6
stress_zz = -80e6              # Vertical stress (lithostatic)
stress_xy = 0.0
stress_xz = 0.0
stress_yz = 0.0

# =============================================================================
# BOUNDARY CONDITIONS
# =============================================================================
[boundary_conditions]
# Hydraulic boundaries
bc_flow_xmin = no_flow
bc_flow_xmax = no_flow
bc_flow_ymin = no_flow
bc_flow_ymax = no_flow
bc_flow_zmin = no_flow
bc_flow_zmax = constant_pressure
bc_pressure_zmax = 45e6

# Mechanical boundaries
bc_mech_xmin = roller          # Normal fixed, tangent free
bc_mech_xmax = roller
bc_mech_ymin = roller
bc_mech_ymax = roller
bc_mech_zmin = fixed           # Fixed base
bc_mech_zmax = traction
bc_traction_zmax = -20e6       # Overburden load

# Thermal boundaries
bc_thermal_xmin = adiabatic
bc_thermal_xmax = adiabatic
bc_thermal_ymin = adiabatic
bc_thermal_ymax = adiabatic
bc_thermal_zmin = fixed_temperature
bc_temperature_zmin = 383.15   # Geothermal gradient
bc_thermal_zmax = fixed_temperature
bc_temperature_zmax = 363.15

# =============================================================================
# OUTPUT REQUESTS
# =============================================================================
[output]
# Primary fields
output_pressure = true
output_saturation = true
output_displacement = true
output_temperature = true

# Derived quantities
output_effective_stress = true
output_volumetric_strain = true
output_permeability_field = true  # See permeability evolution
output_porosity_field = true

# High-fidelity specific outputs
output_transfer_rate = true    # Matrix-fracture transfer
output_creep_strain = true
output_plastic_strain = true
output_damage = true
output_wave_velocities = true  # Biot wave speeds

# Well outputs
output_well_data = true
output_bhp = true
output_well_rates = true
output_cumulative = true

# Error estimates (for AMR)
output_error_indicator = true
output_mesh_quality = true
