# ============================================================================
# Linear Elastic Fracture Mechanics (LEFM) - Hydraulic Fracture Growth
# ============================================================================
#
# This example demonstrates hydraulic fracture propagation based on LEFM theory:
#
# Key Physics:
# -----------
# 1. Stress Intensity Factor: K_I = Y * σ * sqrt(π*a)
#    - Y: geometry factor
#    - σ: applied stress  
#    - a: crack half-length
#
# 2. Initiation Criterion: K_I = K_Ic (fracture toughness)
#
# 3. Propagation: v = C * (K_I - K_Ic) / K_Ic
#    - Velocity proportional to excess stress intensity
#
# 4. Width Profile (Sneddon solution):
#    w(x) = (4*(1-ν²)/E) * sqrt(a² - x²) * (P - σ_min)
#
# Expected Behavior:
# -----------------
# - Phase 1 (0-60s): Pressure builds at wellbore
# - Phase 2: Fracture initiates when K_I reaches K_Ic
# - Phase 3: Propagation with decreasing velocity as fracture lengthens
# - Fracture propagates perpendicular to minimum stress (σ_h = 30 MPa)
#
# Scaling Regimes:
# ---------------
# - Toughness-dominated: L ~ t^(4/5)  (PKN model)
# - Viscosity-dominated: L ~ t^(4/5)  (different coefficients)
# - Leak-off-dominated:  L ~ t^(2/3)  (Carter model)
#
# This example is primarily toughness-dominated due to:
# - Low viscosity fluid (1 cP slickwater)
# - Low leak-off (tight shale formation)
# - Moderate K_Ic (1.0 MPa·m^0.5)
#
# ============================================================================

[SIMULATION]
# Time control
start_time = 0.0
end_time = 3600.0                     # 1 hour hydraulic fracture treatment
dt_initial = 1.0                      # 1 second (fine timestep for accurate initiation)
dt_min = 0.1                          # Minimum timestep
dt_max = 10.0                         # Maximum timestep
max_timesteps = 5000
adaptive_timestepping = true

# Output control (HDF5 is default, more efficient than VTK)
output_frequency = 60                 # Output every 60 timesteps (~1 minute intervals)
output_format = HDF5                  # HDF5 (default), VTK (secondary option)
enable_checkpointing = true
checkpoint_frequency = 100

# Solver tolerances (tight for accurate LEFM coupling)
rtol = 1.0e-7                         # Relative tolerance
atol = 1.0e-9                         # Absolute tolerance
max_nonlinear_iterations = 100
max_linear_iterations = 5000

# Physics models
fluid_model = SINGLE_COMPONENT        # Single-phase water-based frac fluid
solid_model = ELASTIC                 # Linear elasticity (required for LEFM)

# Physics coupling
enable_geomechanics = true            # CRITICAL: Required for stress intensity factor
enable_fractures = true               # Enable hydraulic fracture propagation
enable_thermal = false                # Isothermal (temperature effects negligible)
enable_particle_transport = false     # No proppant in this pure LEFM example
enable_faults = false                 # No pre-existing faults
enable_tidal_forces = false

# ============================================================================
[GRID]
# Fine mesh near wellbore for accurate stress field resolution
nx = 80
ny = 80
nz = 40

# Domain: 400m x 400m x 200m (wellbore at center)
Lx = 400.0
Ly = 400.0
Lz = 200.0

use_unstructured = false              # Structured cartesian mesh
refine_near_wells = true              # Adaptive refinement near wellbore
refinement_levels = 2

# ============================================================================
[ROCK]
# Shale Formation Properties (typical Barnett/Marcellus shale)
# ----------------------------------------------------------------------------

# Porosity and Permeability
porosity = 0.05                       # 5% (low porosity shale)
permeability_x = 0.0001               # 0.1 microDarcy (very tight)
permeability_y = 0.0001               # Isotropic horizontal permeability
permeability_z = 0.00001              # 0.01 microDarcy (lower vertical)
compressibility = 5.0e-10             # Rock compressibility [1/Pa]

# Elastic Properties - CRITICAL FOR LEFM
# ----------------------------------------------------------------------------
youngs_modulus = 25.0e9               # 25 GPa (typical for shale)
poisson_ratio = 0.20                  # 0.20 (relatively low for shale)
density = 2400.0                      # 2400 kg/m³
biot_coefficient = 0.7                # Poroelastic coupling

# Not using viscoelasticity (pure elastic LEFM)
relaxation_time = 1.0e10
viscosity = 1.0e25

# Thermal properties (not active but required)
thermal_conductivity = 1.8
heat_capacity = 800.0
thermal_expansion = 8.0e-6

# LEFM Fracture Parameters - CRITICAL FOR PROPAGATION
# ----------------------------------------------------------------------------
fracture_toughness = 1.0e6            # K_Ic = 1.0 MPa·m^0.5 (typical shale)
fracture_energy = 40.0                # G_c = 40 J/m² (from G = K²/E')

# Relationship: G_c = K_Ic² * (1 - ν²) / E
# With K_Ic = 1 MPa·m^0.5, E = 25 GPa, ν = 0.2:
# G_c = (1e6)² * (1 - 0.04) / 25e9 = 38.4 J/m² ≈ 40 J/m²

# ============================================================================
[FLUID]
# Slickwater Frac Fluid (water with friction reducer)
# ----------------------------------------------------------------------------
density = 1000.0                      # 1000 kg/m³ (water density)
viscosity = 0.001                     # 1 cP (low viscosity - slickwater)
compressibility = 4.5e-10             # 1/Pa (water compressibility)

# Not using multiphase flow (single phase injection)
oil_density_std = 1000.0
gas_density_std = 0.0
water_density_std = 1000.0
oil_viscosity = 0.001
gas_viscosity = 0.00001
water_viscosity = 0.001
solution_GOR = 0.0

# ============================================================================
[FRACTURE1]
# Initial Perforation/Notch
# ----------------------------------------------------------------------------
# Small pre-existing weakness to concentrate stress and initiate fracture
# Location: Domain center (200, 200, 100)
# Orientation: East-West (perpendicular to minimum stress)

type = HYDRAULIC
location = 200.0, 200.0, 100.0, 0.0, 1.0, 0.0
# Format: x, y, z, normal_x, normal_y, normal_z
# Normal (0,1,0) creates E-W fracture perpendicular to σ_h (Y-direction)

# Initial conditions
aperture = 0.0001                     # 0.1 mm initial perforation/notch
permeability = 1.0e-12                # Initial fracture permeability
length = 0.5                          # 0.5 m initial notch length
height = 0.5                          # 0.5 m initial notch height

# LEFM Parameters - Control propagation
toughness = 1.0e6                     # K_Ic = 1.0 MPa·m^0.5
energy = 40.0                         # G_c = 40 J/m²
propagation_constant = 1.0e-3         # Velocity constant C [m/s]

enable_propagation = true             # Allow LEFM-based growth
enable_proppant = false               # No proppant for pure LEFM demo
enable_leakoff = true                 # Carter leakoff model
leakoff_coefficient = 1.0e-7          # C_L = 10^-7 m/s^0.5

# Propagation model
propagation_model = P3D               # Pseudo-3D (allows height growth)
# Alternatives: PKN (plane strain), KGD (plane strain), RADIAL (penny-shaped)

# ============================================================================
[WELL1]
# High-Pressure Injection Well
# ----------------------------------------------------------------------------
name = FRAC_WELL
type = INJECTOR

# Location (grid cell indices - center of domain)
i = 40                                # Grid center X
j = 40                                # Grid center Y  
k = 20                                # Grid center Z

# Control parameters
control_mode = RATE                   # Rate-controlled injection
target_value = 0.05                   # 50 L/s = 0.05 m³/s = ~20 bpm (typical)
max_rate = 0.10                       # 100 L/s maximum (safety limit)
min_bhp = 60.0e6                      # 60 MPa max BHP (switches to pressure control)

# Well geometry
diameter = 0.15                       # 0.15 m = 6 inch wellbore
skin = 0.0                            # No skin (open hole/perforated)
perforation_length = 10.0             # 10 m perforated interval

# ============================================================================
# STRESS STATE - In-situ stresses (far-field boundary conditions)
# ============================================================================
#
# Stress regime: Normal faulting (σ_v > σ_H > σ_h)
# - Vertical stress (σ_v):           40 MPa (overburden)
# - Maximum horizontal stress (σ_H): 35 MPa  
# - Minimum horizontal stress (σ_h): 30 MPa
# - Pore pressure (P_0):             25 MPa (hydrostatic)
#
# Effective stresses:
# - σ'_v = 40 - 25 = 15 MPa
# - σ'_H = 35 - 25 = 10 MPa
# - σ'_h = 30 - 25 = 5 MPa
#
# Fracture will propagate perpendicular to σ_h (E-W direction)
#
# ============================================================================

[BC1]
# Minimum horizontal stress (σ_h) - X boundaries
type = NEUMANN
field = DISPLACEMENT
location = XMIN
value = 0.0
gradient = -30.0e6                    # 30 MPa compressive

[BC2]
type = NEUMANN
field = DISPLACEMENT
location = XMAX
value = 0.0
gradient = 30.0e6                     # 30 MPa compressive

[BC3]
# Maximum horizontal stress (σ_H) - Y boundaries
type = NEUMANN
field = DISPLACEMENT
location = YMIN
value = 0.0
gradient = -35.0e6                    # 35 MPa compressive

[BC4]
type = NEUMANN
field = DISPLACEMENT
location = YMAX
value = 0.0
gradient = 35.0e6                     # 35 MPa compressive

[BC5]
# Vertical stress (overburden) - top boundary
type = NEUMANN
field = DISPLACEMENT
location = ZMAX
value = 0.0
gradient = -40.0e6                    # 40 MPa compressive

[BC6]
# Fixed bottom boundary (no vertical displacement)
type = DIRICHLET
field = DISPLACEMENT
location = ZMIN
value = 0.0

[BC7]
# Far-field pore pressure - X boundaries
type = DIRICHLET
field = PRESSURE
location = XMIN
value = 25.0e6                        # 25 MPa

[BC8]
type = DIRICHLET
field = PRESSURE
location = XMAX
value = 25.0e6                        # 25 MPa

[BC9]
# Far-field pore pressure - Y boundaries
type = DIRICHLET
field = PRESSURE
location = YMIN
value = 25.0e6                        # 25 MPa

[BC10]
type = DIRICHLET
field = PRESSURE
location = YMAX
value = 25.0e6                        # 25 MPa

# ============================================================================
# INITIAL CONDITIONS
# ============================================================================

[IC1]
# Initial pore pressure (hydrostatic)
field = PRESSURE
distribution = UNIFORM
value = 25.0e6                        # 25 MPa (consistent with BCs)

[IC2]
# Initial displacement (zero, in equilibrium with stress BCs)
field = DISPLACEMENT
distribution = UNIFORM
value = 0.0

[IC3]
# Initial saturation (100% water - single phase)
field = SATURATION
distribution = UNIFORM
value = 1.0

# ============================================================================
# MONITORING AND OUTPUT
# ============================================================================

[OUTPUT]
format = HDF5                         # HDF5 default (efficient for large data)
base_path = output/lefm
frequency = 60                        # Output every 60 steps

# Field outputs
write_pressure = true
write_displacement = true
write_stress = true                   # Important for stress intensity analysis
write_strain = true
write_velocity = false
write_permeability = true             # Track permeability changes
write_temperature = false
write_saturation = false

# Fracture-specific outputs
write_fracture_geometry = true        # Fracture length, height, width evolution
write_fracture_pressure = true        # Pressure inside fracture
write_stress_intensity = true         # K_I values for validation
write_propagation_velocity = true     # Fracture tip velocity

# Well outputs
write_well_data = true                # BHP, rate history

# ============================================================================
# POST-PROCESSING AND VISUALIZATION
# ============================================================================
#
# To visualize HDF5 outputs with ParaView:
# 1. Generate XDMF wrapper: python scripts/hdf5_to_xdmf.py output/lefm
# 2. Open XDMF in ParaView: paraview output/lefm/solution.xdmf
#
# To visualize with VTK (legacy):
# - Set output_format = VTK above
# - Open directly: paraview output/lefm/lefm_*.vtu
#
# Key Visualizations:
# ------------------
# 1. Pressure field evolution (shows injection front)
# 2. Stress field (σ_xx, σ_yy, σ_zz, von Mises)
# 3. Displacement field (surface uplift, volumetric strain)
# 4. Fracture geometry (length vs time, width profile)
# 5. Stress intensity factor K_I vs time
#
# Expected Results:
# ----------------
# - Initiation time:        ~60-120 seconds (when K_I = K_Ic)
# - Final fracture length:  ~100-150 m (after 1 hour)
# - Final fracture height:  ~30-50 m
# - Max fracture width:     ~5-10 mm (at wellbore)
# - Net pressure:           ~2-4 MPa above σ_min
# - Total fluid injected:   180 m³ (50 L/s × 3600 s)
# - Leak-off volume:        ~20-30 m³
#
# Validation Against Theory:
# --------------------------
# Compare with analytical solutions:
# 1. PKN model:  L(t) ∝ t^(4/5)  (toughness regime)
# 2. KGD model:  L(t) ∝ t^(2/3)  (toughness regime)
# 3. Width:      w_max = 2·R·K_I/(E'·√π)
#
# References:
# ----------
# - Sneddon (1946): Crack opening displacement
# - Perkins & Kern (1961): PKN model
# - Geertsma & de Klerk (1969): KGD model
# - Adachi & Detournay (2002): Toughness vs viscosity regimes
# - Detournay (2004): Propagation regimes
#
# ============================================================================
