# ==============================================================================
# Induced Seismicity with Implicit-Explicit Time Integration Transition
# ==============================================================================
#
# This example demonstrates automatic transition between implicit (quasi-static)
# and explicit (dynamic) time integration for induced seismicity modeling.
#
# Physical Scenario:
# - Wastewater injection into a deep disposal well over months-years
# - Pore pressure diffuses toward a critically-stressed basement fault
# - When fault reaches criticality, dynamic rupture occurs (seconds)
# - Seismic waves propagate through the domain
# - After event settles, return to quasi-static injection modeling
#
# The IMEX transition manager:
# 1. Starts in IMPLICIT mode (large dt ~hours) for slow pore pressure diffusion
# 2. Monitors Coulomb Failure Function on fault
# 3. When CFF >= 0 (fault failure), switches to EXPLICIT mode (small dt ~ms)
# 4. Captures dynamic rupture and wave propagation
# 5. When kinetic energy decays, returns to IMPLICIT mode
# 6. Process repeats for subsequent induced events
# ==============================================================================

[SIMULATION]
name = induced_seismicity_imex
start_time = 0.0
end_time = 63072000.0               # 2 years (seconds)
dt_initial = 86400.0                # Start with 1 day (will be modified by IMEX)
dt_min = 1e-6                       # Allow very small dt for explicit
dt_max = 604800.0                   # 1 week max
output_frequency = 100
output_format = HDF5

# Physics settings
fluid_model = BLACK_OIL
solid_model = POROELASTODYNAMIC     # Full dynamic poroelasticity with inertia
enable_geomechanics = true
enable_thermal = false
enable_fractures = false
enable_faults = true
enable_poroelastodynamics = true    # Enable Biot wave propagation

# Solver settings
rtol = 1.0e-6
atol = 1.0e-8
max_nonlinear_iterations = 100
max_linear_iterations = 2000

# ==============================================================================
# IMPLICIT-EXPLICIT TIME INTEGRATION TRANSITION
# ==============================================================================
# This is the key section for automatic mode switching

[IMEX]
enabled = true
initial_mode = IMPLICIT             # Start in quasi-static mode

# --------------------------------------------------------------------------
# Implicit Mode Settings (for slow pore pressure diffusion)
# --------------------------------------------------------------------------
implicit_dt_initial = 3600.0        # 1 hour initial timestep
implicit_dt_min = 60.0              # 1 minute minimum
implicit_dt_max = 86400.0           # 1 day maximum
implicit_method = BEULER            # Backward Euler for stability

# --------------------------------------------------------------------------
# Explicit Mode Settings (for dynamic rupture and waves)
# --------------------------------------------------------------------------
explicit_dt_initial = 1e-4          # 0.1 ms initial (CFL limited)
explicit_dt_min = 1e-7              # 0.1 μs minimum
explicit_dt_max = 1e-3              # 1 ms maximum
cfl_factor = 0.5                    # CFL safety factor
explicit_method = EULER             # Forward Euler (or RK, NEWMARK)

# --------------------------------------------------------------------------
# Trigger Conditions (IMPLICIT -> EXPLICIT)
# When any of these conditions are met, switch to explicit mode
# --------------------------------------------------------------------------
trigger_type = COULOMB_FAILURE      # Options: STRESS, COULOMB, SLIP_RATE, VELOCITY
coulomb_threshold = 0.0             # CFF >= 0 means failure (Pa)
stress_threshold = 10.0e6           # Fallback: von Mises stress (Pa)
slip_rate_threshold = 1e-3          # Seismic slip rate threshold (m/s)
velocity_threshold = 1e-4           # Particle velocity threshold (m/s)

# --------------------------------------------------------------------------
# Settling Criteria (EXPLICIT -> IMPLICIT)
# Return to implicit mode when dynamic event has settled
# --------------------------------------------------------------------------
settling_type = COMBINED            # Options: TIME, VELOCITY, ENERGY, SLIP_RATE, COMBINED
min_dynamic_duration = 0.5          # Minimum time in explicit mode (s)
max_dynamic_duration = 30.0         # Force return after this duration (s)
settling_velocity = 1e-6            # Velocity threshold for settling (m/s)
settling_energy_ratio = 0.01        # Energy < 1% of peak
settling_slip_rate = 1e-9           # Slip rate back to interseismic (m/s)
settling_observation_window = 0.1   # Observe settling for this duration (s)

# --------------------------------------------------------------------------
# Time Step Adaptation
# --------------------------------------------------------------------------
adaptive_timestep = true
dt_growth_factor = 1.2              # Max dt increase per step
dt_shrink_factor = 0.5              # dt decrease on failure

# --------------------------------------------------------------------------
# Solver Settings per Mode
# --------------------------------------------------------------------------
implicit_max_iterations = 50
explicit_max_iterations = 10
implicit_rtol = 1e-6
explicit_rtol = 1e-8
implicit_atol = 1e-8
explicit_atol = 1e-10

# --------------------------------------------------------------------------
# Mass Matrix Treatment
# --------------------------------------------------------------------------
use_lumped_mass = true              # Lumped mass for efficient explicit

# --------------------------------------------------------------------------
# Output Control
# --------------------------------------------------------------------------
implicit_output_frequency = 10      # Output every 10 implicit steps
explicit_output_frequency = 100     # Output every 100 explicit steps (dense for dynamics)
log_transitions = true              # Log mode transitions
transition_log_file = output/imex_transitions.log

# --------------------------------------------------------------------------
# Smooth Transition (optional damping ramp)
# --------------------------------------------------------------------------
smooth_transition = true
transition_ramp_time = 0.01         # Ramp damping over 10 ms

# ==============================================================================
# DOMAIN AND GRID
# ==============================================================================

[GRID]
nx = 100
ny = 1                              # 2D cross-section (XZ plane)
nz = 60
Lx = 12000.0                        # 12 km horizontal extent
Ly = 100.0                          # Thin for 2D
Lz = 8000.0                         # 8 km depth

# ==============================================================================
# ROCK PROPERTIES
# ==============================================================================

[ROCK]
# Primary reservoir (sedimentary cover)
constitutive_model = POROELASTIC
porosity = 0.15
permeability_x = 0.1                # 0.1 mD (tight)
permeability_y = 0.1
permeability_z = 0.01
density = 2700.0                    # kg/m³
compressibility = 5.0e-11           # 1/Pa

# Mechanical properties
youngs_modulus = 50.0e9             # 50 GPa
poisson_ratio = 0.25
biot_coefficient = 0.7

# Wave propagation properties (critical for explicit mode)
p_wave_velocity = 5500.0            # m/s
s_wave_velocity = 3200.0            # m/s
quality_factor = 100.0              # Q for attenuation

# Rayleigh damping (α*M + β*K)
damping_alpha = 0.1                 # Mass proportional
damping_beta = 0.0001               # Stiffness proportional

# ==============================================================================
# ROCK2: Crystalline Basement (where fault is located)
# ==============================================================================

[ROCK2]
name = BASEMENT
constitutive_model = POROELASTIC
porosity = 0.02                     # Very low porosity
permeability_x = 0.001              # 1 microDarcy
permeability_y = 0.001
permeability_z = 0.0001
density = 2800.0                    # kg/m³

youngs_modulus = 70.0e9             # 70 GPa (stiffer basement)
poisson_ratio = 0.25
biot_coefficient = 0.5

p_wave_velocity = 6000.0            # m/s
s_wave_velocity = 3500.0            # m/s
quality_factor = 200.0              # Higher Q in basement

# ==============================================================================
# FLUID PROPERTIES
# ==============================================================================

[FLUID]
type = BLACK_OIL
water_density_std = 1050.0          # Brine density (kg/m³)
water_viscosity = 0.0005            # 0.5 cP
oil_density_std = 850.0
oil_viscosity = 0.002
gas_density_std = 0.8
gas_viscosity = 0.000015

# ==============================================================================
# INJECTION WELL
# ==============================================================================

[WELL1]
name = DISPOSAL-WELL
type = INJECTOR
i = 30                              # 3.6 km from left boundary
j = 0
k = 40                              # 5.3 km depth (in sediments)
control_mode = RATE
target_value = 0.00116              # 100 m³/day (1.34e-3 m³/s)
max_bhp = 55.0e6                    # Max injection pressure (Pa)
fluid = WATER
diameter = 0.15                     # 6 inch

# ==============================================================================
# MONITORING WELLS
# ==============================================================================

[WELL2]
name = MONITOR-NEAR-FAULT
type = OBSERVATION
i = 50                              # Near fault
j = 0
k = 48                              # At basement depth
control_mode = RATE
target_value = 0.0

[WELL3]
name = MONITOR-SURFACE
type = OBSERVATION
i = 50
j = 0
k = 5                               # Near surface (for wave detection)
control_mode = RATE
target_value = 0.0

# ==============================================================================
# CRITICALLY STRESSED BASEMENT FAULT
# ==============================================================================

[FAULT1]
name = BASEMENT_FAULT
x = 6000.0                          # Center of domain
y = 0.0
z = 5500.0                          # 5.5 km depth (in basement)
strike = 0.0                        # N-S striking
dip = 60.0                          # 60 degree dip (typical thrust)
length = 3000.0                     # 3 km along dip
width = 6000.0                      # 6 km along strike

# Friction law: Rate-and-State (velocity weakening = unstable)
friction_law = RATE_STATE_AGING
rate_state_a = 0.010                # Direct velocity effect
rate_state_b = 0.016                # State evolution effect (b > a = VW)
rate_state_dc = 0.005               # 5 mm critical slip distance
rate_state_v0 = 1.0e-9              # Background creep rate (m/s)
rate_state_f0 = 0.6                 # Reference friction coefficient

# Initial stress state (near critical)
cohesion = 2.0e6                    # 2 MPa cohesion
initial_normal_stress = 130.0e6    # 130 MPa (lithostatic at 5 km)
initial_shear_stress = 75.0e6      # High shear, near failure

# ==============================================================================
# SEISMICITY SETTINGS
# ==============================================================================

[SEISMICITY]
enable = true
friction_law = RATE_STATE_AGING
nucleation_size = 2.0               # Minimum nucleation patch (m)
seismic_slip_rate = 1.0e-3          # Threshold for seismic vs aseismic (m/s)
b_value = 1.0                       # Gutenberg-Richter b-value
aftershocks = true                  # Model aftershock sequences
stress_transfer = true              # Include Coulomb stress transfer
max_magnitude = 5.5                 # Maximum expected magnitude
catalog_file = output/seismic_catalog.csv

# ==============================================================================
# DYNAMICS SETTINGS (Wave Propagation)
# ==============================================================================

[DYNAMICS]
enable = true
static_triggering = false           # We use IMEX instead
quality_factor = 100.0
damping_alpha = 0.1
damping_beta = 0.0001

# Dynamic permeability changes from seismic waves
dynamic_permeability = true
permeability_sensitivity = 1.0
permeability_recovery_time = 86400.0  # 1 day recovery

# ==============================================================================
# INITIAL CONDITIONS
# ==============================================================================

[IC1]
field = PRESSURE
distribution = GRADIENT
value = 20.0e6                      # Hydrostatic at surface (20 MPa at 2 km)
gradient = 0, 0, 10000              # 10 kPa/m (slightly above hydrostatic)

[IC2]
field = TEMPERATURE
distribution = GRADIENT
value = 300.0                       # 27°C at surface
gradient = 0, 0, 0.025              # 25 K/km geothermal gradient

[IC3]
field = DISPLACEMENT
distribution = UNIFORM
value = 0.0                         # Zero initial displacement

# ==============================================================================
# BOUNDARY CONDITIONS
# ==============================================================================

[BC1]
type = DIRICHLET
field = DISPLACEMENT
location = ZMAX                     # Free surface
value = 0.0                         # Zero traction (implicit)

[BC2]
type = ABSORBING
field = DISPLACEMENT
location = XMIN                     # Absorbing boundary for waves
value = 0.0

[BC3]
type = ABSORBING
field = DISPLACEMENT
location = XMAX
value = 0.0

[BC4]
type = ABSORBING
field = DISPLACEMENT
location = ZMIN                     # Bottom absorbing
value = 0.0

[BC5]
type = NEUMANN
field = PRESSURE
location = ALL                      # No-flow boundaries
value = 0.0

# ==============================================================================
# OUTPUT CONFIGURATION
# ==============================================================================

[OUTPUT]
format = VTK                        # VTK for visualization
path = output/induced_seismicity_imex
frequency = 10

# Fields to output
pressure = true
displacement = true
velocity = true                     # Important for wave visualization
stress = true
strain = false
permeability = true                 # Track dynamic permeability changes
fault_slip = true
seismic_catalog = true

# Unit preferences for output
pressure_unit = MPa
displacement_unit = m
velocity_unit = m/s
stress_unit = MPa

# ==============================================================================
# NOTES ON RUNNING THIS SIMULATION
# ==============================================================================
#
# 1. The simulation starts in IMPLICIT mode with dt ~ 1 hour
#    - Pore pressure diffuses slowly toward the fault
#    - Quasi-static poroelastic deformation
#
# 2. As pore pressure increases, effective normal stress decreases
#    - Fault gets closer to failure (CFF approaches 0)
#
# 3. When CFF >= 0 on any fault patch:
#    - IMEX manager triggers transition to EXPLICIT mode
#    - Time step drops to ~0.1 ms (CFL limited)
#    - Dynamic rupture propagates along fault
#    - Seismic waves radiate through domain
#
# 4. Event detection:
#    - Slip rate exceeds seismic threshold (~1 mm/s)
#    - Moment is accumulated to compute magnitude
#    - Event is logged to seismic catalog
#
# 5. Settling detection (after ~1-30 seconds):
#    - Kinetic energy decays below 1% of peak
#    - Particle velocities drop below threshold
#    - Slip rate returns to interseismic values
#
# 6. Transition back to IMPLICIT:
#    - Resume large time steps for continued injection
#    - Process repeats for subsequent events
#
# Expected behavior:
# - First event after ~weeks-months of injection
# - Event duration: ~1-10 seconds (explicit phase)
# - Multiple events possible as injection continues
# - Each event captured with full wave propagation
#
# ==============================================================================
