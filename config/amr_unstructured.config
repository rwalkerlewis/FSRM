# ==============================================================================
# Adaptive Mesh Refinement (AMR) Configuration Example
# ==============================================================================
# Demonstrates AMR for unstructured grids using PETSc DMPlex/DMForest
#
# This example simulates a two-phase flow problem with:
# - Local refinement around wells and saturation fronts
# - Coarsening in regions with smooth solution
# - Dynamic load balancing for parallel efficiency
# ==============================================================================

[simulation]
name = "amr_two_phase_flow"
type = "reservoir"
physics = "two_phase_flow"
coupled = true
time_stepping = "adaptive"
end_time = 365.0        # days
output_interval = 30.0  # days

# ==============================================================================
# Initial Grid (Unstructured)
# ==============================================================================
[grid]
type = "unstructured"
format = "gmsh"
file = "reservoir_coarse.msh"

# Alternative: generate box mesh internally
# type = "box"
# dimension = 2
# nx = 20
# ny = 20
# xmin = 0.0
# xmax = 1000.0
# ymin = 0.0
# ymax = 1000.0

# ==============================================================================
# Adaptive Mesh Refinement Settings
# ==============================================================================
[amr]
enabled = true
method = "plex_adapt"   # Options: plex_refine, plex_adapt, forest_p4est, pragmatic, mmg

# Adaptation frequency
adapt_every = 5         # Time steps between adaptations
adapt_on_change = true  # Also adapt when solution changes significantly

# ==============================================================================
# Refinement Criteria
# ==============================================================================
[amr.criterion]
type = "combined"       # Options: gradient, hessian, residual, jump, feature, combined

# For combined criterion, specify weights for each component
weight_pressure = 0.3
weight_saturation = 1.0     # Prioritize saturation front tracking
weight_velocity = 0.2
weight_temperature = 0.0    # Not relevant for isothermal

# ==============================================================================
# Refinement Strategy
# ==============================================================================
[amr.strategy]
type = "fixed_fraction"     # Options: fixed_fraction, fixed_number, threshold, equilibration

# Fixed fraction parameters
refine_fraction = 0.20      # Refine top 20% of cells by error
coarsen_fraction = 0.05     # Coarsen bottom 5% of cells by error

# Threshold parameters (used if type = "threshold")
refine_threshold = 0.5      # Refine if normalized error > 0.5
coarsen_threshold = 0.05    # Coarsen if normalized error < 0.05

# ==============================================================================
# Mesh Limits
# ==============================================================================
[amr.limits]
max_refinement_level = 4    # Maximum number of refinement levels
min_refinement_level = 0    # Minimum level (coarsest allowed)

max_cells = 100000          # Maximum total cell count
min_cells = 500             # Minimum total cell count

min_cell_size = 1.0         # Minimum cell size [m]
max_cell_size = 100.0       # Maximum cell size [m]

# ==============================================================================
# Quality Constraints
# ==============================================================================
[amr.quality]
min_quality = 0.2           # Minimum cell quality (0 to 1)
max_aspect_ratio = 5.0      # Maximum aspect ratio

# ==============================================================================
# Feature-Based Refinement
# ==============================================================================
[amr.features]
preserve_boundaries = true
preserve_wells = true
preserve_faults = true
buffer_layers = 2           # Extra layers of refinement around marked cells

# Well refinement
[[amr.features.wells]]
name = "PROD1"
x = 50.0
y = 50.0
z = 0.0
radius = 20.0               # Refinement radius around well
level = 3                   # Target refinement level

[[amr.features.wells]]
name = "INJ1"
x = 950.0
y = 950.0
z = 0.0
radius = 30.0
level = 3

# Fault refinement
[[amr.features.faults]]
name = "Main_Fault"
# Fault trace points (x, y, z)
trace = [[200, 0, 0], [400, 500, 0], [600, 1000, 0]]
width = 10.0                # Fault zone width
level = 2

# Box refinement regions
[[amr.features.boxes]]
name = "high_resolution_region"
xmin = 0.0
xmax = 200.0
ymin = 0.0
ymax = 200.0
zmin = 0.0
zmax = 100.0
level = 2

# ==============================================================================
# Solution Transfer
# ==============================================================================
[amr.transfer]
method = "interpolation"    # Options: interpolation, projection, injection, conservative
conservative = true         # Ensure mass conservation during transfer

# ==============================================================================
# Load Balancing
# ==============================================================================
[amr.balance]
enabled = true
method = "parmetis"         # Options: parmetis, ptscotch, simple
rebalance_threshold = 0.2   # Rebalance if load imbalance > 20%

# ==============================================================================
# Output
# ==============================================================================
[amr.output]
write_mesh = true           # Output adapted mesh
write_errors = true         # Output error field
format = "vtk"              # Options: vtk, hdf5, exodusii
prefix = "amr_output"

# ==============================================================================
# Fluid Properties (Two-Phase)
# ==============================================================================
[fluid]
type = "black_oil"
num_phases = 2

[fluid.water]
density = 1000.0            # kg/m³
viscosity = 1.0e-3          # Pa·s
compressibility = 4.5e-10   # 1/Pa

[fluid.oil]
density = 850.0             # kg/m³
viscosity = 5.0e-3          # Pa·s
compressibility = 1.0e-9    # 1/Pa

# ==============================================================================
# Rock Properties
# ==============================================================================
[rock]
porosity = 0.2
permeability = 100.0e-15    # m² (100 mD)
compressibility = 4.35e-10  # 1/Pa

# ==============================================================================
# Relative Permeability (Corey Model)
# ==============================================================================
[relperm]
model = "corey"
Swc = 0.2                   # Connate water saturation
Sor = 0.2                   # Residual oil saturation
nw = 2.0                    # Water Corey exponent
no = 2.0                    # Oil Corey exponent
krw_max = 0.3               # Maximum water relative permeability
kro_max = 1.0               # Maximum oil relative permeability

# ==============================================================================
# Wells
# ==============================================================================
[[wells]]
name = "PROD1"
type = "producer"
location = [50.0, 50.0]
control = "bhp"
bhp = 20.0e6                # Pa (200 bar)

[[wells]]
name = "INJ1"
type = "injector"
location = [950.0, 950.0]
control = "rate"
rate = 0.001                # m³/s water injection

# ==============================================================================
# Initial Conditions
# ==============================================================================
[initial]
pressure = 30.0e6           # Pa (300 bar)
water_saturation = 0.2      # Connate water

# ==============================================================================
# Boundary Conditions
# ==============================================================================
[boundary]
type = "no_flow"            # All boundaries no-flow

# ==============================================================================
# Solver Settings
# ==============================================================================
[solver]
type = "impes"              # IMPES for two-phase
pressure_solver = "gmres"
preconditioner = "ilu"
max_iterations = 100
tolerance = 1.0e-8

# ==============================================================================
# Time Stepping
# ==============================================================================
[time]
initial_dt = 0.1            # days
max_dt = 10.0               # days
min_dt = 0.001              # days

# CFL-based adaptive time stepping
cfl_max = 0.5               # Maximum CFL number
cfl_target = 0.3            # Target CFL number

# ==============================================================================
# Summary Output
# ==============================================================================
[summary]
vectors = [
    # Field totals
    "FWPR", "FOPR", "FWIR", "FWPT", "FOPT", "FWIT",
    
    # Well rates
    "WWPR:PROD1", "WOPR:PROD1", "WWIR:INJ1",
    
    # Well pressures
    "WBHP:PROD1", "WBHP:INJ1",
    
    # AMR-specific outputs
    "AMR_NCELLS",       # Total cell count
    "AMR_MAX_LEVEL",    # Current maximum refinement level
    "AMR_NREFINE",      # Cells refined this step
    "AMR_NCOARSEN",     # Cells coarsened this step
    "AMR_ERROR_MAX",    # Maximum error indicator
    "AMR_ERROR_MEAN"    # Mean error indicator
]

# ==============================================================================
# PETSc Options
# ==============================================================================
[petsc]
options = [
    "-dm_plex_check_all",
    "-dm_view",
    "-amr_refine_fraction 0.2",
    "-amr_coarsen_fraction 0.05",
    "-amr_max_level 4",
    "-amr_max_cells 100000"
]
