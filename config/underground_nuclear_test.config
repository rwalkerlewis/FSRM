# ==============================================================================
# Underground Nuclear Test Simulation
# ==============================================================================
# Models the detonation of an underground nuclear device with:
# - Near-field cavity and damage zone formation
# - Plastic deformation and shatter zone
# - Seismic wave generation and propagation
# - Ground motion at surface stations
# - Spall and compaction effects
#
# Based on physics of the Nevada Test Site explosions and similar events
# ==============================================================================

[SIMULATION]
name = underground_nuclear_test
description = Contained underground nuclear explosion with seismic wave generation

# Time parameters - milliseconds to seconds for wave propagation
start_time = 0.0
end_time = 60.0                      # 60 seconds to capture surface waves
dt_initial = 1.0e-6                  # 1 microsecond for shock wave resolution
dt_min = 1.0e-8                      # Minimum for shock front
dt_max = 0.01                        # Maximum after shock passes
max_timesteps = 1000000

# Adaptive timestepping based on wavefront tracking
adaptive_dt = true
cfl_number = 0.4                     # CFL for stability with shocks

# Output configuration
output_frequency = 100
output_format = HDF5
enable_checkpointing = true
checkpoint_frequency = 10000

# Physics models
fluid_model = NONE                   # Dry rock
solid_model = ELASTOPLASTIC_DP       # Drucker-Prager plasticity

# Enable key physics
enable_geomechanics = true
enable_elastodynamics = true
enable_thermal = true                # Thermal effects from explosion
enable_fractures = true              # Damage and fracturing
enable_plasticity = true             # Plastic deformation near source

# High-order accurate wave propagation
use_discontinuous_galerkin = true
dg_order = 4
use_ader_time_integration = true
enable_local_time_stepping = true
lts_rate = 2

# Solver settings
rtol = 1.0e-6
atol = 1.0e-8
max_nonlinear_iterations = 50

# GPU acceleration for large problem
use_gpu = true
gpu_mode = AUTO

# ==============================================================================
# Explosion Source Parameters
# ==============================================================================
[EXPLOSION_SOURCE]
type = NUCLEAR_UNDERGROUND

# Device parameters
yield_kt = 150.0                     # 150 kilotons yield (like Sedan test)
depth_of_burial = 1000.0             # 1 km depth (meters)
location_x = 25000.0                 # Center of domain (m)
location_y = 25000.0
location_z = -1000.0                 # Negative = below surface

# Cavity formation parameters (scaled from empirical relations)
# Cavity radius: R_c ≈ 55 * W^0.3 * (ρ/2.65)^(-1/3) meters (W in kt)
# For 150 kt in granite: ~110 m radius
cavity_radius = 110.0                # meters
cavity_radius_scaling = EMPIRICAL    # Use empirical scaling laws

# Damage zones (scaled from nuclear testing data)
crushed_zone_radius = 220.0          # ~2x cavity radius
fractured_zone_radius = 550.0        # ~5x cavity radius
damaged_zone_radius = 1100.0         # ~10x cavity radius

# Reduced Displacement Potential (source model)
# RDP approximation for seismic source
source_model = MUELLER_MURPHY        # Mueller-Murphy model
corner_frequency_scaling = PATTON    # Patton scaling for corner frequency

# Source time function parameters
source_time_function = NUCLEAR_EXPLOSION
rise_time = 0.05                     # 50 ms rise time
overshoot_factor = 1.2               # Source overshoot

# Moment tensor representation (isotropic + CLVD + DC)
# Nuclear tests are predominantly isotropic with some CLVD
isotropic_fraction = 0.70            # 70% isotropic (explosion)
clvd_fraction = 0.25                 # 25% CLVD (spall/cavity collapse)
double_couple_fraction = 0.05        # 5% DC (tectonic release)

# Scalar moment (from empirical relations for 150 kt)
# log(M0) ≈ 16.9 + log(W) for contained explosions
scalar_moment = 1.2e17               # N·m

# Spall modeling
enable_spall = true
spall_velocity = 3.0                 # m/s spall velocity
spall_depth = 200.0                  # Spall layer depth (m)

# ==============================================================================
# Grid Configuration
# ==============================================================================
[GRID]
# Large domain to capture full waveforms
nx = 200
ny = 200
nz = 100

# Domain: 50 km × 50 km × 25 km (half-space)
Lx = 50000.0
Ly = 50000.0
Lz = 25000.0

# Origin at surface
origin_x = 0.0
origin_y = 0.0
origin_z = 0.0                       # Z positive downward (surface at 0)

use_unstructured = false

# Adaptive mesh refinement around source
[amr]
enabled = true
method = plex_refine

[amr.criterion]
type = feature
feature_type = explosion_source

[amr.strategy]
type = fixed_fraction
refine_fraction = 0.3
coarsen_fraction = 0.1

[amr.limits]
max_refinement_level = 4
max_cells = 5000000
min_cell_size = 10.0                 # 10 m minimum near source

[amr.features]
buffer_layers = 3

# High resolution around explosion
[amr.features.explosion]
x = 25000.0
y = 25000.0
z = 1000.0
radius = 2000.0                      # 2 km refined region
level = 4

# ==============================================================================
# Material Properties - Granite Host Rock
# ==============================================================================
[ROCK]
name = GRANITE_HOST
constitutive_model = ELASTOPLASTIC_DP

# Elastic properties (typical granite)
youngs_modulus = 55.0e9              # 55 GPa
poisson_ratio = 0.25
density = 2650.0                     # kg/m³

# Wave velocities (derived)
# V_p = sqrt(E(1-ν)/ρ(1+ν)(1-2ν)) ≈ 5500 m/s
# V_s = sqrt(E/2ρ(1+ν)) ≈ 3200 m/s
p_wave_velocity = 5500.0
s_wave_velocity = 3200.0

# Attenuation
quality_factor_p = 500.0             # High Q for granite
quality_factor_s = 250.0

# Drucker-Prager plasticity parameters
failure_criterion = DRUCKER_PRAGER
cohesion = 25.0e6                    # 25 MPa cohesion
friction_angle = 35.0                # degrees
dilation_angle = 10.0                # degrees

# Tension cutoff
tensile_strength = 10.0e6            # 10 MPa

# Hardening/softening
hardening_type = LINEAR
hardening_modulus = 1.0e9            # Pa
enable_softening = true
softening_strain = 0.05

# Damage model parameters
damage_model = SCALAR_DAMAGE
initial_damage = 0.0
max_damage = 0.99
damage_evolution = STRAIN_BASED

# Porosity and compaction
porosity = 0.01                      # Low porosity granite
compressibility = 5.0e-11

# Permeability (very low for intact granite)
permeability_x = 1.0e-18             # m² (≈ 1 nanodarcy)
permeability_y = 1.0e-18
permeability_z = 1.0e-18

# Thermal properties
thermal_conductivity = 2.5           # W/m·K
specific_heat = 800.0                # J/kg·K
thermal_expansion = 8.0e-6           # 1/K

# ==============================================================================
# Damage Zone Materials
# ==============================================================================
[ROCK_CRUSHED]
name = CRUSHED_ZONE
constitutive_model = ELASTOPLASTIC_DP

# Reduced properties in crushed zone
youngs_modulus = 5.0e9               # 5 GPa (reduced)
poisson_ratio = 0.30
density = 2200.0                     # Lower due to fracturing

cohesion = 1.0e6                     # 1 MPa (minimal)
friction_angle = 30.0
tensile_strength = 0.5e6             # Very low

initial_damage = 0.8                 # High initial damage
porosity = 0.20                      # High porosity from crushing

[ROCK_FRACTURED]
name = FRACTURED_ZONE
constitutive_model = ELASTOPLASTIC_DP

youngs_modulus = 25.0e9              # Intermediate
poisson_ratio = 0.27
density = 2500.0

cohesion = 10.0e6
friction_angle = 32.0
tensile_strength = 5.0e6

initial_damage = 0.4
porosity = 0.05

# ==============================================================================
# Initial Conditions
# ==============================================================================
[IC1]
field = DISPLACEMENT
distribution = UNIFORM
value = 0.0

[IC2]
field = VELOCITY
distribution = UNIFORM
value = 0.0

[IC3]
# Lithostatic stress state
field = STRESS
distribution = LITHOSTATIC
surface_stress = 0.0
density = 2650.0
gravity = 9.81

[IC4]
# Initial temperature with geothermal gradient
field = TEMPERATURE
distribution = GRADIENT
value = 288.15                       # Surface temperature (15°C)
gradient = 0.0, 0.0, 0.025           # 25 K/km geothermal gradient

[IC5]
# Explosion thermal pulse (applied in source region)
field = TEMPERATURE_EXPLOSION
distribution = RADIAL_DECAY
center = 25000.0, 25000.0, 1000.0
peak_value = 5000000.0               # Peak temperature (K) - plasma
decay_exponent = 2.0
cutoff_radius = 500.0

# ==============================================================================
# Boundary Conditions
# ==============================================================================
[BC1]
# Free surface at top
type = FREE_SURFACE
location = ZMIN
field = DISPLACEMENT

[BC2]
# Absorbing boundaries on all other sides
type = ABSORBING
location = XMIN
field = DISPLACEMENT
absorbing_type = PML
pml_layers = 20
pml_strength = 100.0

[BC3]
type = ABSORBING
location = XMAX
field = DISPLACEMENT
absorbing_type = PML
pml_layers = 20
pml_strength = 100.0

[BC4]
type = ABSORBING
location = YMIN
field = DISPLACEMENT
absorbing_type = PML
pml_layers = 20
pml_strength = 100.0

[BC5]
type = ABSORBING
location = YMAX
field = DISPLACEMENT
absorbing_type = PML
pml_layers = 20
pml_strength = 100.0

[BC6]
type = ABSORBING
location = ZMAX
field = DISPLACEMENT
absorbing_type = PML
pml_layers = 20
pml_strength = 100.0

# ==============================================================================
# Seismic Stations (Receivers)
# ==============================================================================
[RECEIVERS]
output_format = SAC                  # Standard seismic format
sampling_rate = 100.0                # 100 Hz
output_velocity = true
output_displacement = true
output_acceleration = true
output_strain = true

# Near-field stations (1-5 km)
[RECEIVER1]
name = NF01
location = 26000.0, 25000.0, 0.0     # 1 km from GZ
components = 3

[RECEIVER2]
name = NF02
location = 27500.0, 25000.0, 0.0     # 2.5 km

[RECEIVER3]
name = NF03
location = 30000.0, 25000.0, 0.0     # 5 km

# Intermediate stations (10-20 km)
[RECEIVER4]
name = INT01
location = 35000.0, 25000.0, 0.0     # 10 km

[RECEIVER5]
name = INT02
location = 40000.0, 25000.0, 0.0     # 15 km

[RECEIVER6]
name = INT03
location = 45000.0, 25000.0, 0.0     # 20 km

# Array stations (various azimuths at 10 km)
[RECEIVER7]
name = ARR_N
location = 25000.0, 35000.0, 0.0     # North

[RECEIVER8]
name = ARR_NE
location = 32071.0, 32071.0, 0.0     # NE

[RECEIVER9]
name = ARR_E
location = 35000.0, 25000.0, 0.0     # East

[RECEIVER10]
name = ARR_SE
location = 32071.0, 17929.0, 0.0     # SE

# Depth station (borehole)
[RECEIVER11]
name = BOREHOLE_500
location = 27000.0, 25000.0, 500.0   # 500 m depth

[RECEIVER12]
name = BOREHOLE_1500
location = 27000.0, 25000.0, 1500.0  # 1.5 km depth

# ==============================================================================
# Output Configuration
# ==============================================================================
[OUTPUT]
format = HDF5
path = output/underground_nuclear

# Volume output
save_displacement = true
save_velocity = true
save_stress = true
save_strain = true
save_damage = true
save_plastic_strain = true
save_temperature = true

# Frequency (every N timesteps)
volume_output_frequency = 500

# Surface output (denser)
surface_output = true
surface_output_frequency = 100
surface_output_fields = displacement,velocity,acceleration

# Cross-sections
save_cross_sections = true
cross_section_planes = XZ_Y25000, YZ_X25000
cross_section_frequency = 200

# Seismic moment history
save_moment_rate = true
save_source_time_function = true

# Ground motion metrics
compute_pgv = true                   # Peak Ground Velocity
compute_pga = true                   # Peak Ground Acceleration
compute_spectral_response = true     # Response spectra

# ==============================================================================
# Analysis
# ==============================================================================
[ANALYSIS]
# Seismic moment calculation
compute_seismic_moment = true
moment_calculation_region = cavity   # Around cavity

# Magnitude estimation
compute_magnitude = true
magnitude_type = mb, Ms, Mw          # Body, surface, moment magnitudes

# Damage assessment
compute_damage_volume = true
damage_threshold = 0.1               # Threshold for counting damage

# Cavity parameters
compute_cavity_size = true
compute_chimney_height = true

# Spall analysis
analyze_spall = true
spall_velocity_threshold = 1.0       # m/s

# Discrimination ratios
compute_ms_mb_ratio = true           # For event identification
