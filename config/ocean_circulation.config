# ==============================================================================
# Ocean Circulation Modeling Configuration
# ==============================================================================
#
# This configuration sets up a 3D ocean circulation simulation
# using the primitive equations approach.
#
# Physical processes included:
#   - Wind-driven circulation
#   - Thermohaline dynamics
#   - Coriolis effects
#   - Tidal forcing
#   - Baroclinic and barotropic modes
#
# Suitable for:
#   - Regional ocean modeling
#   - Western boundary current studies
#   - Upwelling/downwelling simulations
#   - Seasonal variability studies
#
# ==============================================================================

[SIMULATION]
name = ocean_circulation
description = 3D primitive equations ocean circulation model

# Time parameters
start_time = 0.0
end_time = 2592000.0            # 30 days in seconds
dt_initial = 600.0              # 10 minute baroclinic time step
dt_min = 60.0
dt_max = 1800.0

# Output settings
output_frequency = 86400        # Daily output
output_format = NETCDF
output_dir = output/ocean_circulation

# Physics coupling
enable_ocean_circulation = true
enable_thermohaline = true
enable_wave_dynamics = false
enable_sediment_transport = false

# GPU acceleration
use_gpu = true
gpu_mode = CPU_FALLBACK

# Solver settings
rtol = 1.0e-5
atol = 1.0e-7
max_nonlinear_iterations = 20

# ==============================================================================
# Domain Configuration
# ==============================================================================

[DOMAIN]
# Example: California Current System region
lon_min = -135.0
lon_max = -115.0
lat_min = 30.0
lat_max = 50.0

# Horizontal resolution
nx = 200                        # ~11 km resolution
ny = 200

# Vertical configuration
nz = 30                         # 30 sigma levels

# Coordinate reference
coordinate_system = WGS84
vertical_datum = MSL

# ==============================================================================
# Grid Configuration
# ==============================================================================

[GRID]
# Horizontal spacing (approximate)
dx_km = 11.0
dy_km = 11.0

# Vertical coordinate
vertical_type = SIGMA
num_sigma_levels = 30

# Sigma coordinate stretching (Song and Haidvogel)
theta_s = 5.0                   # Surface stretching parameter
theta_b = 0.4                   # Bottom stretching parameter
h_c = 10.0                      # Critical depth (m)

# ==============================================================================
# Hydrodynamic Model Configuration
# ==============================================================================

[HYDRODYNAMIC]
model_type = PRIMITIVE_3D      # SHALLOW_WATER_2D, PRIMITIVE_3D, BOUSSINESQ

# Time stepping
time_scheme = SPLIT_EXPLICIT
barotropic_steps = 30           # Number of barotropic steps per baroclinic
cfl_number = 0.8
adaptive_timestep = true

# Physical parameters
gravity = 9.81
reference_density = 1025.0      # kg/m³

# Coriolis
use_coriolis = true
use_beta_plane = true
latitude_reference = 40.0
f0 = 9.37e-5                    # Coriolis at 40°N (rad/s)
beta = 2.07e-11                 # Beta parameter (1/m/s)

# ==============================================================================
# Advection and Mixing
# ==============================================================================

[ADVECTION]
scheme = MUSCL                  # UPWIND_FIRST, CENTERED, MUSCL, WENO
limiter = MINMOD

[MIXING]
# Horizontal mixing
turbulence_closure = SMAGORINSKY
horizontal_viscosity = 100.0    # m²/s (background)
horizontal_diffusivity = 50.0   # m²/s (background)
smagorinsky_coefficient = 0.1

# Vertical mixing
vertical_closure = KPP          # CONSTANT, KPP, MELLOR_YAMADA_25, GLS
vertical_viscosity = 1.0e-4     # m²/s (background)
vertical_diffusivity = 1.0e-5   # m²/s (background)

# KPP parameters
kpp_critical_ri = 0.3
kpp_surface_layer_fraction = 0.1

# ==============================================================================
# Bottom Friction
# ==============================================================================

[BOTTOM_FRICTION]
type = QUADRATIC               # LINEAR, QUADRATIC, MANNING, LOG_LAYER
drag_coefficient = 0.0025
manning_n = 0.025
roughness_length = 0.01        # meters (for log-layer)

# ==============================================================================
# Equation of State
# ==============================================================================

[EQUATION_OF_STATE]
type = UNESCO                   # LINEAR, UNESCO, TEOS10
use_nonlinear = true

# Linear EOS parameters (if type = LINEAR)
reference_temperature = 10.0    # °C
reference_salinity = 35.0       # PSU
thermal_expansion = 2.0e-4      # 1/K
haline_contraction = 7.5e-4     # 1/PSU

# ==============================================================================
# Initial Conditions
# ==============================================================================

[INITIAL_CONDITIONS]
type = STRATIFIED              # REST, STRATIFIED, FROM_FILE

# Stratified initial state
surface_temperature = 18.0      # °C
bottom_temperature = 4.0        # °C
surface_salinity = 33.5         # PSU
bottom_salinity = 34.5          # PSU
thermocline_depth = 100.0       # meters

# Or load from file
# initial_file = data/ocean_initial.nc

# ==============================================================================
# Boundary Conditions
# ==============================================================================

[BOUNDARY_WEST]
type = OPEN
open_boundary_type = FLATHER    # CLAMPED, RADIATION, FLATHER, SPONGE
sponge_width = 50000.0          # 50 km sponge layer
sponge_strength = 0.001

# Tidal forcing
enable_tides = true
tidal_constituents = M2, S2, K1, O1

[BOUNDARY_EAST]
type = LAND                     # Continental boundary

[BOUNDARY_SOUTH]
type = OPEN
open_boundary_type = FLATHER
sponge_width = 50000.0

[BOUNDARY_NORTH]
type = OPEN
open_boundary_type = FLATHER
sponge_width = 50000.0

# ==============================================================================
# Wind Forcing
# ==============================================================================

[WIND_FORCING]
type = CLIMATOLOGICAL          # CONSTANT, ANALYTICAL, CLIMATOLOGICAL, FROM_FILE

# Constant wind (if type = CONSTANT)
u10_constant = 5.0              # m/s (eastward)
v10_constant = -2.0             # m/s (southward)

# Analytical wind (if type = ANALYTICAL)
# wind_pattern = ALONGSHORE       # ALONGSHORE, CROSS_SHORE, CURL
# wind_amplitude = 10.0

# Wind stress formulation
use_bulk_formula = true
drag_coefficient_type = LARGE_POND  # CONSTANT, LARGE_POND, COARE

# Wind stress file (if type = FROM_FILE)
# wind_file = data/wind_forcing.nc

# ==============================================================================
# Heat Flux
# ==============================================================================

[HEAT_FLUX]
type = BULK_FORMULA            # CONSTANT, BULK_FORMULA, FROM_FILE

# Bulk formula parameters
use_shortwave = true
use_longwave = true
use_sensible = true
use_latent = true

# Shortwave penetration
penetrative_shortwave = true
sw_attenuation_type = JERLOV_IA  # Water type

# Relaxation to climatology
relaxation_timescale = 864000.0  # 10 days (seconds)

# ==============================================================================
# Freshwater Flux
# ==============================================================================

[FRESHWATER_FLUX]
type = EVAP_PRECIP             # NONE, EVAP_PRECIP, RELAXATION, FROM_FILE

# Virtual salt flux for E-P
use_virtual_salt_flux = true

# Salinity relaxation
salinity_relaxation_timescale = 2592000.0  # 30 days

# ==============================================================================
# Tidal Forcing
# ==============================================================================

[TIDES]
enabled = true
forcing_type = BOUNDARY         # BOUNDARY, BODY, BOTH

# Tidal constituents to include
constituents = M2, S2, N2, K2, K1, O1, P1, Q1

# Constituent amplitudes (can be loaded from TPXO or FES)
tidal_data_source = TPXO9       # ANALYTICAL, TPXO9, FES2014

# Body tides (if BODY or BOTH)
include_body_tides = false
love_number_h = 0.609
love_number_k = 0.299

# ==============================================================================
# River Inputs
# ==============================================================================

[RIVERS]
enabled = true
num_rivers = 2

[RIVER_1]
name = Columbia_River
longitude = -124.0
latitude = 46.25
discharge = 7500.0              # m³/s (annual mean)
temperature = 12.0              # °C
salinity = 0.0                  # PSU (freshwater)

[RIVER_2]
name = Sacramento_River
longitude = -122.4
latitude = 38.0
discharge = 700.0               # m³/s
temperature = 15.0
salinity = 0.0

# ==============================================================================
# Bathymetry
# ==============================================================================

[BATHYMETRY]
source = GEBCO                  # CONSTANT, ANALYTICAL, GEBCO, ETOPO, USER_FILE

# GEBCO file
gebco_file = data/GEBCO_2023_Pacific.nc

# Minimum depth (for wetting/drying and numerics)
minimum_depth = 10.0            # meters

# Bathymetry smoothing
smooth_bathymetry = true
smoothing_factor = 0.2

# Maximum bathymetry gradient (for sigma coordinates)
max_slope = 0.25                # |∇h|/h

# ==============================================================================
# Wetting and Drying
# ==============================================================================

[WETTING_DRYING]
enabled = true
dry_depth = 0.5                 # meters
minimum_depth = 1.0             # meters

# ==============================================================================
# Output Configuration
# ==============================================================================

[OUTPUT]
format = NETCDF
path = output/ocean_circulation

# Time-averaged output
save_mean_fields = true
averaging_period = 86400        # Daily averages

# Instantaneous snapshots
snapshot_interval = 21600       # Every 6 hours

# Variables to output
save_elevation = true
save_velocity_3d = true
save_temperature = true
save_salinity = true
save_density = true
save_vertical_velocity = true
save_mixing_coefficients = true

# Derived quantities
save_vorticity = true
save_streamfunction = true
save_mixed_layer_depth = true
save_heat_content = true

# Station output (time series at specific locations)
save_stations = true

[STATION_1]
name = Point_Conception
longitude = -120.5
latitude = 34.4

[STATION_2]
name = Cape_Mendocino
longitude = -124.4
latitude = 40.4

[STATION_3]
name = Cape_Blanco
longitude = -124.6
latitude = 42.8

# ==============================================================================
# Diagnostics and Analysis
# ==============================================================================

[DIAGNOSTICS]
# Energy diagnostics
compute_kinetic_energy = true
compute_potential_energy = true
compute_available_potential_energy = true

# Volume and mass conservation
check_mass_conservation = true
mass_conservation_tolerance = 1.0e-6

# Transport calculations
compute_volume_transport = true
transport_sections = California_Current, Davidson_Current

[TRANSPORT_SECTION_1]
name = California_Current
i_start = 100
j_start = 0
i_end = 100
j_end = 200

[TRANSPORT_SECTION_2]
name = Davidson_Current
i_start = 150
j_start = 50
i_end = 150
j_end = 150

# ==============================================================================
# Parallel Configuration
# ==============================================================================

[PARALLEL]
decomposition = AUTO            # AUTO, MANUAL
num_tiles_x = 0                 # 0 = auto-detect
num_tiles_y = 0
halo_width = 2

# ==============================================================================
# Expected Results
# ==============================================================================
# 
# This configuration should produce:
# - California Current: southward flow of 1-3 Sv along coast
# - Upwelling-favorable conditions with onshore Ekman transport
# - Thermocline depth variations: 20-100 m
# - SST variations: 10-20°C
# - Mixed layer depth: 20-80 m (seasonal)
# - Davidson Current (winter): northward flow near coast
#
# Key features to observe:
# - Coastal upwelling (cold water at surface near coast)
# - California Current (equatorward flow)
# - Mesoscale eddies (after ~2 weeks of simulation)
# - Tidal currents (semidiurnal signal in velocities)
#
# ==============================================================================
