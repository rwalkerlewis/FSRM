# ==============================================================================
# Multi-Domain Reservoir with Fault using Gmsh Mesh
# ==============================================================================
# This example demonstrates loading an unstructured Gmsh mesh with:
#   - Multiple material domains (reservoir, caprock, basement)
#   - Fault surface with rate-state friction
#   - Boundary conditions from named physical groups
#
# Prerequisites:
#   Create the mesh using Gmsh with the geometry file below, then save as .msh
#   gmsh -3 gmsh_multi_domain_fault.geo -o meshes/multi_domain_fault.msh
#
# Usage: mpirun -np 4 fsrm -c config/gmsh_multi_domain_fault.config
# ==============================================================================

[SIMULATION]
name = multi_domain_faulted_reservoir
start_time = 0.0
end_time = 2592000.0                      # 30 days in seconds
dt_initial = 3600.0                       # 1 hour
dt_min = 1.0
dt_max = 86400.0                          # 1 day
max_timesteps = 10000
output_frequency = 24

fluid_model = SINGLE_COMPONENT
solid_model = POROELASTIC

enable_geomechanics = true
enable_thermal = false
enable_faults = true

rtol = 1.0e-6
atol = 1.0e-8

[GRID]
# =============================================================================
# Gmsh Mesh Configuration
# =============================================================================
mesh_type = GMSH
mesh_file = meshes/multi_domain_fault.msh
use_unstructured = true

# -----------------------------------------------------------------------------
# Material Domain Mapping
# -----------------------------------------------------------------------------
# Maps Gmsh physical volume names to material property sections
# Format: physical_group:MATERIAL_SECTION, ...
#
# In your Gmsh .geo file, define:
#   Physical Volume("reservoir") = {...};
#   Physical Volume("caprock") = {...};
#   Physical Volume("basement") = {...};
gmsh_material_mapping = reservoir:ROCK_RESERVOIR, caprock:ROCK_CAPROCK, basement:ROCK_BASEMENT

# -----------------------------------------------------------------------------
# Fault Surface Mapping
# -----------------------------------------------------------------------------
# Maps Gmsh physical surface names to fault configurations
# Format: physical_group:FAULT_SECTION[:split]
#
# Add ":split" to enable split nodes for discontinuous displacement across fault
#
# In your Gmsh .geo file, define:
#   Physical Surface("main_fault") = {...};
gmsh_fault_mapping = main_fault:FAULT_MAIN:split

# -----------------------------------------------------------------------------
# Boundary Surface Names
# -----------------------------------------------------------------------------
# Physical surface names for boundary conditions
# In your Gmsh .geo file, define Physical Surface for each boundary
gmsh_boundaries = inlet, outlet, top, bottom, north, south

# Mesh refinement level (0 = no additional refinement)
gmsh_refinement_level = 0

# =============================================================================
# Rock Properties by Domain
# =============================================================================

[ROCK_RESERVOIR]
name = Reservoir_Sandstone
porosity = 0.22
permeability_x = 150 mD
permeability_y = 150 mD
permeability_z = 15 mD
compressibility = 4.5e-10 1/Pa

# Mechanical properties
youngs_modulus = 12 GPa
poisson_ratio = 0.25
density = 2400 kg/m3
biot_coefficient = 0.85

# Thermal properties
thermal_conductivity = 2.5 W/(m-K)
heat_capacity = 850 J/(kg-K)

[ROCK_CAPROCK]
name = Caprock_Shale
porosity = 0.08
permeability_x = 0.01 mD
permeability_y = 0.01 mD
permeability_z = 0.001 mD
compressibility = 1.0e-10 1/Pa

youngs_modulus = 25 GPa
poisson_ratio = 0.32
density = 2650 kg/m3
biot_coefficient = 0.70

thermal_conductivity = 1.8 W/(m-K)
heat_capacity = 900 J/(kg-K)

[ROCK_BASEMENT]
name = Basement_Granite
porosity = 0.02
permeability_x = 0.0001 mD
permeability_y = 0.0001 mD
permeability_z = 0.00001 mD
compressibility = 5.0e-11 1/Pa

youngs_modulus = 55 GPa
poisson_ratio = 0.20
density = 2750 kg/m3
biot_coefficient = 0.50

thermal_conductivity = 3.0 W/(m-K)
heat_capacity = 800 J/(kg-K)

# =============================================================================
# Fluid Properties
# =============================================================================

[FLUID]
type = SINGLE_PHASE
density = 1020 kg/m3
viscosity = 0.8 cP
compressibility = 4.5e-10 1/Pa

# =============================================================================
# Fault Configuration
# =============================================================================

[FAULT_MAIN]
name = Main_Fault_Zone
x = 2500.0                                # Approximate center X (m)
y = 2500.0                                # Approximate center Y (m)
z = -1500.0                               # Approximate center depth (m)

# Geometry will be computed from mesh, these are overrides if needed
# strike = 0.0                            # degrees from N (auto-computed)
# dip = 60.0                              # degrees (auto-computed)

# Friction law: COULOMB, RATE_STATE_AGING, RATE_STATE_SLIP, SLIP_WEAKENING
friction_law = RATE_STATE_AGING

# Coulomb parameters
static_friction = 0.6
dynamic_friction = 0.4
cohesion = 1.0 MPa

# Rate-state parameters (for RATE_STATE_* laws)
rate_state_a = 0.010                      # Direct effect parameter
rate_state_b = 0.015                      # Evolution effect (b>a = unstable)
rate_state_dc = 0.0001 m                  # Critical slip distance
rate_state_v0 = 1.0e-6 m/s                # Reference velocity
rate_state_f0 = 0.6                       # Reference friction coefficient

# Split node configuration (for discontinuous displacement)
use_split_nodes = true
split_node_method = PENALTY               # PENALTY, LAGRANGE, NITSCHE
penalty_normal = 1.0e12                   # Normal penalty stiffness (Pa/m)
penalty_tangent = 1.0e10                  # Tangential penalty stiffness (Pa/m)
allow_separation = false                  # Allow fault opening

# =============================================================================
# Wells
# =============================================================================

[WELL1]
name = INJECTOR_1
type = INJECTOR
x = 1000.0
y = 2500.0
z = -1200.0
control_mode = RATE
target_value = 0.005 m3/s                 # 5 L/s injection rate
min_bhp = 5.0 MPa
max_bhp = 50.0 MPa
fluid = WATER

[WELL2]
name = PRODUCER_1
type = PRODUCER
x = 4000.0
y = 2500.0
z = -1200.0
control_mode = BHP
target_value = 15.0 MPa
max_rate = 0.01 m3/s

# =============================================================================
# Boundary Conditions
# =============================================================================

[BC1]
type = DIRICHLET
field = PRESSURE
location = inlet                          # Gmsh physical group name
value = 25.0 MPa

[BC2]
type = DIRICHLET
field = PRESSURE
location = outlet
value = 18.0 MPa

[BC3]
type = NEUMANN
field = PRESSURE
location = north, south, top              # Multiple boundaries
value = 0.0                               # No-flow

[BC4]
type = DIRICHLET
field = DISPLACEMENT
location = bottom
value = 0.0, 0.0, 0.0                     # Fixed base

[BC5]
type = NEUMANN
field = DISPLACEMENT
location = top
value = 0.0, 0.0, 0.0                     # Stress-free top

# =============================================================================
# Initial Conditions
# =============================================================================

[IC1]
field = PRESSURE
distribution = GRADIENT
value = 20.0 MPa                          # Pressure at reference depth
gradient = 0.0, 0.0, 10000.0              # Pa/m (hydrostatic)

[IC2]
field = TEMPERATURE
distribution = GRADIENT
value = 300.0 K                           # Temperature at surface
gradient = 0.0, 0.0, 0.025                # K/m (geothermal gradient)

# =============================================================================
# Output Configuration
# =============================================================================

[OUTPUT]
format = VTK
path = output/multi_domain_fault
frequency = 24                            # Output every 24 timesteps

# Field outputs
pressure = true
displacement = true
stress = true
strain = false
velocity = false
permeability = true
saturation = false

# Fault-specific outputs
fault_slip = true
seismic_catalog = true

# Output units
pressure_unit = MPa
displacement_unit = mm
stress_unit = MPa
permeability_unit = mD

# =============================================================================
# Example Gmsh Geometry File
# =============================================================================
# Save this section as 'gmsh_multi_domain_fault.geo' and run:
#   gmsh -3 gmsh_multi_domain_fault.geo -o meshes/multi_domain_fault.msh
#
# SetFactory("OpenCASCADE");
# 
# // Domain dimensions (m)
# Lx = 5000;
# Ly = 5000;
# Lz = 2000;
# 
# // Layer thicknesses
# h_caprock = 200;
# h_reservoir = 300;
# 
# // Depths (negative z)
# z_top = 0;
# z_caprock_bottom = -h_caprock;
# z_reservoir_bottom = z_caprock_bottom - h_reservoir;
# z_basement_bottom = -Lz;
# 
# // Fault position
# fault_x = 2500;
# fault_dip = 60 * Pi / 180;  // 60 degrees
# 
# // Create layers
# Box(1) = {0, 0, z_caprock_bottom, Lx, Ly, h_caprock};     // Caprock
# Box(2) = {0, 0, z_reservoir_bottom, Lx, Ly, h_reservoir}; // Reservoir
# Box(3) = {0, 0, z_basement_bottom, Lx, Ly, Lz - h_caprock - h_reservoir}; // Basement
# 
# // Create fault plane
# Point(100) = {fault_x, 0, z_basement_bottom};
# Point(101) = {fault_x + Lz/Tan(fault_dip), 0, z_top};
# Point(102) = {fault_x + Lz/Tan(fault_dip), Ly, z_top};
# Point(103) = {fault_x, Ly, z_basement_bottom};
# 
# Line(100) = {100, 101};
# Line(101) = {101, 102};
# Line(102) = {102, 103};
# Line(103) = {103, 100};
# Curve Loop(100) = {100, 101, 102, 103};
# Plane Surface(100) = {100};
# 
# // Fragment all volumes with fault plane
# BooleanFragments{ Volume{1,2,3}; Surface{100}; Delete; }{}
# 
# // Physical groups
# Physical Volume("caprock") = {1, 4};
# Physical Volume("reservoir") = {2, 5};
# Physical Volume("basement") = {3, 6};
# Physical Surface("main_fault") = {100};  // Adjust surface number
# 
# // Boundary surfaces (adjust numbers based on output)
# Physical Surface("inlet") = {...};
# Physical Surface("outlet") = {...};
# Physical Surface("top") = {...};
# Physical Surface("bottom") = {...};
# Physical Surface("north") = {...};
# Physical Surface("south") = {...};
# 
# // Mesh refinement near fault
# Field[1] = Distance;
# Field[1].SurfacesList = {100};
# 
# Field[2] = Threshold;
# Field[2].IField = 1;
# Field[2].LcMin = 25;
# Field[2].LcMax = 150;
# Field[2].DistMin = 50;
# Field[2].DistMax = 500;
# 
# Background Field = 2;
# 
# Mesh.CharacteristicLengthMin = 25;
# Mesh.CharacteristicLengthMax = 150;
# Mesh.Algorithm3D = 1;
# Mesh.Optimize = 1;
# ==============================================================================
