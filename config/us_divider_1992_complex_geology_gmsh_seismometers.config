# ==============================================================================
# Divider (1992) - Complex Geology + Gmsh Mesh (US last underground test style)
# ==============================================================================
# This example pairs a *high-detail* Gmsh geologic model (layers + heterogeneity
# bodies + damage halos + divider/secondary fault cores) with an underground
# explosion-style source configuration.
#
# Mesh generation:
#   gmsh -3 meshes/us_divider/divider_complex_geology.geo \
#        -format msh4 -bin 0 -o meshes/us_divider/divider_complex_geology_3d.msh
#
# Run:
#   mpirun -np 4 fsrm -c config/us_divider_1992_complex_geology_gmsh.config
# ==============================================================================

[SIMULATION]
name = us_divider_1992_complex_geology_gmsh
start_time = 0.0
end_time = 30.0

dt_initial = 1.0e-5
dt_min = 1.0e-7
dt_max = 0.02
max_timesteps = 400000

adaptive_dt = true
cfl_number = 0.45

# Physics (dry rock + elastodynamics + inelastic near-source behavior)
fluid_model = NONE
solid_model = ELASTOPLASTIC_DP

enable_geomechanics = true
enable_elastodynamics = true
enable_thermal = true
enable_fractures = true
enable_plasticity = true

# Numerics
use_discontinuous_galerkin = true
dg_order = 3
use_ader_time_integration = true
enable_local_time_stepping = true
lts_rate = 2

rtol = 1.0e-6
atol = 1.0e-9
max_nonlinear_iterations = 40

# Keep runnable on CPU-only environments
use_gpu = false
gpu_mode = CPU_FALLBACK

# ==============================================================================
# Explosion Source (Divider-style contained underground shot)
# ==============================================================================
[EXPLOSION_SOURCE]
# Use the underground nuclear phenomenology pathway
type = NUCLEAR_UNDERGROUND

yield_kt = 1.0
# Depth of burial (m) and explicit 3D location (matches .geo GZx/GZy/GZz)
depth_of_burial = 800.0
location_x = 5600.0
location_y = 4000.0
location_z = -800.0

# Empirical cavity/damage scaling (educational)
cavity_radius = 55.0
crushed_zone_radius = 260.0
fractured_zone_radius = 650.0
damaged_zone_radius = 1300.0

source_model = MUELLER_MURPHY
corner_frequency_scaling = PATTON
source_time_function = NUCLEAR_EXPLOSION
rise_time = 0.01
overshoot_factor = 1.1

isotropic_fraction = 0.80
clvd_fraction = 0.18
double_couple_fraction = 0.02

scalar_moment = 1.0e15

enable_spall = true
spall_depth = 80.0
spall_velocity = 1.5

# ==============================================================================
# Grid (Gmsh)
# ==============================================================================
[GRID]
mesh_type = GMSH
#
# NOTE: PETSc's Gmsh reader (DMPlexCreateGmshFromFile) is strict about 2D surface
# elements matching facets of 3D volume elements. The repo-shipped Divider mesh
# includes 2D elements that are not facet-consistent for PETSc, so this example
# uses a *volume-only* derivative where the $Elements section has been filtered
# to keep only 3D tetrahedra.
mesh_file = meshes/us_divider/divider_complex_geology_3d_volonly.msh
use_unstructured = true

# Material domain mapping (physical volume -> material section)
# NOTE: upstream/downstream are separate physical volumes but share lithology sections.
# Damage halos and fault cores are explicit domains.
gmsh_material_mapping = soil_upstream:ROCK_SOIL, soil_downstream:ROCK_SOIL, alluvium_upstream:ROCK_ALLUVIUM, alluvium_downstream:ROCK_ALLUVIUM, tuff1_upstream:ROCK_TUFF1, tuff1_downstream:ROCK_TUFF1, tuff2_upstream:ROCK_TUFF2, tuff2_downstream:ROCK_TUFF2, welded_tuff_upstream:ROCK_WELDED_TUFF, welded_tuff_downstream:ROCK_WELDED_TUFF, vitric_tuff_upstream:ROCK_VITRIC_TUFF, vitric_tuff_downstream:ROCK_VITRIC_TUFF, carbonate_upstream:ROCK_CARBONATE, carbonate_downstream:ROCK_CARBONATE, metasediment_upstream:ROCK_METASED, metasediment_downstream:ROCK_METASED, basement_upstream:ROCK_BASEMENT, basement_downstream:ROCK_BASEMENT, intrusive_dome:ROCK_INTRUSIVE_DOME, tuff_channel_lens:ROCK_CHANNEL_LENS, chimney_pipe:ROCK_CHIMNEY, divider_fault_core:ROCK_DIVIDER_GOUGE, secondary_fault_core:ROCK_SECONDARY_GOUGE, damage_crushed:ROCK_CRUSHED, damage_fractured:ROCK_FRACTURED, damage_damaged:ROCK_DAMAGED

# Boundary physical surfaces
# (All are named in the .geo and appear in $PhysicalNames)
gmsh_boundaries = surface, bottom, upstream, downstream, north, south

gmsh_refinement_level = 0

# ==============================================================================
# Materials (representative / educational)
# ==============================================================================
# All materials use ELASTOPLASTIC_DP here to keep the constitutive model uniform.
# In practice, you might mix elastic/plastic/damage models per unit.

[ROCK_SOIL]
name = Soil_Colluvium
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 0.2 GPa
poisson_ratio = 0.30
density = 1900 kg/m3
cohesion = 0.2 MPa
friction_angle = 28.0
dilation_angle = 5.0
tensile_strength = 0.05 MPa
quality_factor_p = 50
quality_factor_s = 25

[ROCK_ALLUVIUM]
name = Alluvium
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 1.0 GPa
poisson_ratio = 0.30
density = 2100 kg/m3
cohesion = 0.5 MPa
friction_angle = 30.0
dilation_angle = 6.0
tensile_strength = 0.1 MPa
quality_factor_p = 80
quality_factor_s = 40

[ROCK_TUFF1]
name = Tuff_Unit_1
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 8.0 GPa
poisson_ratio = 0.28
density = 2300 kg/m3
cohesion = 5.0 MPa
friction_angle = 32.0
dilation_angle = 8.0
tensile_strength = 1.0 MPa
quality_factor_p = 200
quality_factor_s = 100

[ROCK_TUFF2]
name = Tuff_Unit_2
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 12.0 GPa
poisson_ratio = 0.27
density = 2400 kg/m3
cohesion = 8.0 MPa
friction_angle = 34.0
dilation_angle = 9.0
tensile_strength = 2.0 MPa
quality_factor_p = 250
quality_factor_s = 120

[ROCK_WELDED_TUFF]
name = Welded_Tuff
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 18.0 GPa
poisson_ratio = 0.26
density = 2500 kg/m3
cohesion = 12.0 MPa
friction_angle = 35.0
dilation_angle = 10.0
tensile_strength = 3.0 MPa
quality_factor_p = 300
quality_factor_s = 150

[ROCK_VITRIC_TUFF]
name = Vitric_Tuff
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 10.0 GPa
poisson_ratio = 0.28
density = 2350 kg/m3
cohesion = 6.0 MPa
friction_angle = 33.0
dilation_angle = 8.0
tensile_strength = 1.5 MPa
quality_factor_p = 220
quality_factor_s = 110

[ROCK_CARBONATE]
name = Carbonate
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 35.0 GPa
poisson_ratio = 0.25
density = 2650 kg/m3
cohesion = 20.0 MPa
friction_angle = 36.0
dilation_angle = 10.0
tensile_strength = 6.0 MPa
quality_factor_p = 450
quality_factor_s = 220

[ROCK_METASED]
name = Metasediments_Argillite
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 28.0 GPa
poisson_ratio = 0.27
density = 2700 kg/m3
cohesion = 18.0 MPa
friction_angle = 34.0
dilation_angle = 9.0
tensile_strength = 5.0 MPa
quality_factor_p = 400
quality_factor_s = 200

[ROCK_BASEMENT]
name = Basement
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 55.0 GPa
poisson_ratio = 0.25
density = 2750 kg/m3
cohesion = 25.0 MPa
friction_angle = 35.0
dilation_angle = 10.0
tensile_strength = 10.0 MPa
quality_factor_p = 600
quality_factor_s = 300

[ROCK_INTRUSIVE_DOME]
name = Intrusive_Dome
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 65.0 GPa
poisson_ratio = 0.23
density = 2850 kg/m3
cohesion = 30.0 MPa
friction_angle = 37.0
dilation_angle = 10.0
tensile_strength = 12.0 MPa
quality_factor_p = 700
quality_factor_s = 350

[ROCK_CHANNEL_LENS]
name = Channel_Lens
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 9.0 GPa
poisson_ratio = 0.28
density = 2350 kg/m3
cohesion = 4.0 MPa
friction_angle = 31.0
dilation_angle = 8.0
tensile_strength = 0.8 MPa
quality_factor_p = 220
quality_factor_s = 110

[ROCK_CHIMNEY]
name = Chimney_Breccia
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 2.0 GPa
poisson_ratio = 0.30
density = 2100 kg/m3
cohesion = 0.8 MPa
friction_angle = 30.0
dilation_angle = 6.0
tensile_strength = 0.2 MPa
quality_factor_p = 120
quality_factor_s = 60

[ROCK_DIVIDER_GOUGE]
name = Divider_Fault_Core_Gouge
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 3.0 GPa
poisson_ratio = 0.30
density = 2400 kg/m3
cohesion = 1.0 MPa
friction_angle = 28.0
dilation_angle = 3.0
tensile_strength = 0.2 MPa
quality_factor_p = 150
quality_factor_s = 75

[ROCK_SECONDARY_GOUGE]
name = Secondary_Fault_Core_Gouge
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 4.0 GPa
poisson_ratio = 0.30
density = 2450 kg/m3
cohesion = 1.5 MPa
friction_angle = 29.0
dilation_angle = 4.0
tensile_strength = 0.3 MPa
quality_factor_p = 160
quality_factor_s = 80

[ROCK_CRUSHED]
name = Crushed_Zone
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 1.0 GPa
poisson_ratio = 0.30
density = 2200 kg/m3
cohesion = 0.3 MPa
friction_angle = 28.0
dilation_angle = 2.0
tensile_strength = 0.05 MPa

[ROCK_FRACTURED]
name = Fractured_Zone
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 6.0 GPa
poisson_ratio = 0.28
density = 2400 kg/m3
cohesion = 2.0 MPa
friction_angle = 30.0
dilation_angle = 5.0
tensile_strength = 0.5 MPa

[ROCK_DAMAGED]
name = Damaged_Zone
constitutive_model = ELASTOPLASTIC_DP
youngs_modulus = 12.0 GPa
poisson_ratio = 0.27
density = 2500 kg/m3
cohesion = 6.0 MPa
friction_angle = 32.0
dilation_angle = 7.0
tensile_strength = 1.0 MPa

# ==============================================================================
# Initial Conditions
# ==============================================================================
[IC1]
field = DISPLACEMENT
distribution = UNIFORM
value = 0.0

[IC2]
field = VELOCITY
distribution = UNIFORM
value = 0.0

[IC3]
field = STRESS
distribution = LITHOSTATIC
surface_stress = 0.0
density = 2550.0 kg/m3
gravity = 9.81

[IC4]
field = TEMPERATURE
distribution = GRADIENT
value = 288.15
gradient = 0.0, 0.0, 0.025

# ==============================================================================
# Boundary Conditions (named Gmsh physical surfaces)
# ==============================================================================
[BC1]
# Free surface at top
type = FREE_SURFACE
location = surface
field = DISPLACEMENT

[BC2]
# Absorbing boundaries on all other outer faces
type = ABSORBING
location = bottom, upstream, downstream, north, south
field = DISPLACEMENT
absorbing_type = PML
pml_layers = 12
pml_strength = 80.0

# ==============================================================================
# Output
# ==============================================================================
[OUTPUT]
format = HDF5
path = output/us_divider_1992_complex_geology_seismometers

save_displacement = true
save_velocity = true
save_stress = true
save_damage = true
save_temperature = true

volume_output_frequency = 1000
surface_output = true
surface_output_frequency = 200

# ==============================================================================
# Virtual seismometers (historical stations operating during the Divider test)
# Source for station coordinates: IRIS FDSN station service queried for 1992-09-23
# within ~0.35 degrees of the Divider event location (37.021, -115.988).
# ==============================================================================
[SEISMOMETERS]
enabled = true
output_dir = output/us_divider_1992_complex_geology_seismometers/seismograms
formats = SAC,MSEED
start_time_utc = 1992-09-23T15:04:00
default_sample_rate_hz = 100.0
default_quantity = VELOCITY

[SEISMOMETER_TPNV]
net = US
sta = TPNV
loc = 00
channels = BHN,BHE,BHZ
# NOTE: The production Divider mesh is a near-field (12 km x 8 km) model and
# cannot include the true 20â€“40 km station offsets. We preserve each station's
# azimuth from the Divider shot and place it within the near-field domain.
# Real station metadata (IRIS, active on 1992-09-23):
#   US.TPNV  lat=36.9488 lon=-116.2495 elev=1600 m
location_xyz = 5470.0, 3957.518332765243, -955.4701627209879
lowpass_corner_hz = 20.0
noise_std = 0.0

[SEISMOMETER_NSP]
net = SN
sta = NSP
loc = 00
channels = BHN,BHE,BHZ
# Real station metadata (IRIS, active on 1992-09-23):
#   SN.NSP   lat=36.7278 lon=-116.2124 elev=1242 m
location_xyz = 5519.613989175232, 3867.384058126396, -591.3109940014633
lowpass_corner_hz = 20.0
noise_std = 0.0

[ANALYSIS]
compute_seismic_moment = true
compute_magnitude = true
magnitude_type = mb, Mw
compute_ms_mb_ratio = true
compute_damage_volume = true
damage_threshold = 0.1
