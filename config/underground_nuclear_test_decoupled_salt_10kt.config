# ==============================================================================
# Underground Nuclear Test (Decoupled / Weakly Coupled) - Salt Cavity Scenario
# ==============================================================================
# Purpose:
# - Demonstrate a "decoupled" underground nuclear test concept where the device is
#   fired in/near a large cavity in salt, reducing seismic coupling.
# - Useful for CTBT monitoring/discrimination examples (lower mb for a given yield).
#
# Notes:
# - This is an educational configuration illustrating common knobs:
#   - Larger effective cavity radius
#   - Salt host properties (lower strength, different wave speeds/Q)
#   - Lower effective scalar moment / coupling
# - Not a calibration to a particular historical event.
# ==============================================================================

[SIMULATION]
name = underground_nuclear_test_decoupled_salt_10kt
description = 10 kt decoupled/weakly-coupled underground nuclear test in salt cavity

start_time = 0.0
end_time = 45.0

dt_initial = 2.0e-6
dt_min = 1.0e-8
dt_max = 0.02
max_timesteps = 600000

adaptive_dt = true
cfl_number = 0.4

output_frequency = 200
output_format = HDF5
enable_checkpointing = true
checkpoint_frequency = 20000

fluid_model = NONE
solid_model = ELASTOPLASTIC_DP
enable_geomechanics = true
enable_elastodynamics = true
enable_thermal = true
enable_fractures = true
enable_plasticity = true

use_discontinuous_galerkin = true
dg_order = 3
use_ader_time_integration = true
enable_local_time_stepping = true

# Salt problems can be CPU-friendly; turn GPU on only if available
use_gpu = false
gpu_mode = CPU_FALLBACK

# ==============================================================================
# Explosion Source (decoupled)
# ==============================================================================
[EXPLOSION_SOURCE]
type = NUCLEAR_UNDERGROUND

yield_kt = 10.0
depth_of_burial = 800.0
location_x = 20000.0
location_y = 20000.0
location_z = -800.0

# Decoupling knob: large cavity relative to yield
# (Conceptually: shot fired in a cavity -> reduced seismic radiation)
cavity_radius = 160.0
cavity_radius_scaling = OVERRIDE

crushed_zone_radius = 260.0
fractured_zone_radius = 600.0
damaged_zone_radius = 1200.0

source_model = MUELLER_MURPHY
corner_frequency_scaling = PATTON
source_time_function = NUCLEAR_EXPLOSION
rise_time = 0.03
overshoot_factor = 1.05

# More isotropic source; less CLVD from spall if overburied/contained
isotropic_fraction = 0.88
clvd_fraction = 0.10
double_couple_fraction = 0.02

# Reduced effective scalar moment to represent weaker coupling (illustrative)
scalar_moment = 3.0e15

enable_spall = false

# ==============================================================================
# Grid
# ==============================================================================
[GRID]
nx = 220
ny = 220
nz = 120

Lx = 40000.0
Ly = 40000.0
Lz = 20000.0

origin_x = 0.0
origin_y = 0.0
origin_z = 0.0

use_unstructured = false

[amr]
enabled = true
method = plex_refine

[amr.criterion]
type = feature
feature_type = explosion_source

[amr.limits]
max_refinement_level = 3
max_cells = 4000000
min_cell_size = 15.0

[amr.features.decoupled_shot]
x = 20000.0
y = 20000.0
z = 800.0
radius = 2500.0
level = 3

# ==============================================================================
# Host Material Properties (salt)
# ==============================================================================
[ROCK]
name = SALT_HOST
constitutive_model = ELASTOPLASTIC_DP

# Typical halite-like values (order-of-magnitude)
youngs_modulus = 25.0e9
poisson_ratio = 0.30
density = 2160.0

p_wave_velocity = 4500.0
s_wave_velocity = 2500.0

quality_factor_p = 200.0
quality_factor_s = 120.0

failure_criterion = DRUCKER_PRAGER
cohesion = 5.0e6
friction_angle = 25.0
dilation_angle = 5.0
tensile_strength = 2.0e6

damage_model = SCALAR_DAMAGE
initial_damage = 0.0
max_damage = 0.99
damage_evolution = STRAIN_BASED

porosity = 0.005
compressibility = 2.0e-10
permeability_x = 1.0e-20
permeability_y = 1.0e-20
permeability_z = 1.0e-20

thermal_conductivity = 5.0
specific_heat = 900.0
thermal_expansion = 4.0e-5

# ==============================================================================
# Boundary Conditions
# ==============================================================================
[BC1]
type = FREE_SURFACE
location = ZMIN
field = DISPLACEMENT

[BC2]
type = ABSORBING
location = XMIN, XMAX, YMIN, YMAX, ZMAX
field = DISPLACEMENT
absorbing_type = PML
pml_layers = 16
pml_strength = 90.0

# ==============================================================================
# Receivers
# ==============================================================================
[RECEIVERS]
output_format = HDF5
sampling_rate = 100.0
output_velocity = true
output_displacement = true

[RECEIVER_ARRAY_RADIAL]
type = LINE
start = 20000.0, 20000.0, 0.0
end = 40000.0, 20000.0, 0.0
num_stations = 24
fields = displacement, velocity, acceleration

# ==============================================================================
# Output
# ==============================================================================
[OUTPUT]
format = HDF5
path = output/underground_nuclear_decoupled_salt_10kt

save_displacement = true
save_velocity = true
save_stress = true
save_damage = true

volume_output_frequency = 1000
surface_output = true
surface_output_frequency = 200

[ANALYSIS]
compute_seismic_moment = true
compute_magnitude = true
magnitude_type = mb, Mw
compute_ms_mb_ratio = true
compute_damage_volume = true
damage_threshold = 0.1

