# ==============================================================================
# Atmospheric Nuclear Test with Coupled Physics
# ==============================================================================
# Comprehensive simulation of an atmospheric nuclear detonation including:
# - Fireball and thermal radiation
# - Atmospheric shock wave propagation  
# - Ground coupling and seismic wave generation
# - Radiation transport (gamma, neutron, fallout)
# - Electromagnetic Pulse (EMP) generation
# - Atmospheric structure and ionization
#
# Based on physics of atmospheric tests (e.g., Castle Bravo, Tsar Bomba scale)
# ==============================================================================

[SIMULATION]
name = atmospheric_nuclear_test
description = Surface/low-altitude nuclear detonation with full coupled physics

# Time parameters
# Phase 1: 0-1 ms - Initial radiation and fireball
# Phase 2: 1-100 ms - Shock formation and EMP
# Phase 3: 0.1-10 s - Blast wave propagation
# Phase 4: 10-300 s - Ground motion and atmospheric effects
start_time = 0.0
end_time = 300.0                     # 5 minutes for full waveform
dt_initial = 1.0e-9                  # 1 nanosecond for EMP resolution
dt_min = 1.0e-12                     # Picoseconds for gamma flash
dt_max = 0.1                         # Maximum after initial phases

# Multi-phase adaptive timestepping
adaptive_dt = true
phase_adaptive = true
phase1_end = 1.0e-3
phase1_dt_max = 1.0e-7
phase2_end = 0.1
phase2_dt_max = 1.0e-5
phase3_end = 10.0
phase3_dt_max = 0.01

# Output
output_frequency = 100
output_format = HDF5
enable_checkpointing = true
checkpoint_frequency = 5000

# Physics models - Multi-domain coupling
fluid_model = COMPRESSIBLE_NS        # Compressible Navier-Stokes for atmosphere
solid_model = ELASTODYNAMIC          # Ground response

# Enable physics modules
enable_geomechanics = true
enable_elastodynamics = true
enable_thermal = true
enable_radiation = true              # Radiation transport
enable_electromagnetic = true        # EMP physics
enable_atmosphere = true             # Atmospheric modeling
enable_ionization = true             # Ionospheric effects

# Multi-physics coupling
coupling_mode = FULLY_COUPLED
atmosphere_ground_coupling = true
radiation_thermal_coupling = true
emp_ionization_coupling = true

# Numerical methods
use_discontinuous_galerkin = true
dg_order = 4
use_ader_time_integration = true
enable_local_time_stepping = true

# Solvers
rtol = 1.0e-6
atol = 1.0e-10

# GPU required for this scale
use_gpu = true
gpu_mode = GPU_ONLY

# ==============================================================================
# Nuclear Device Parameters
# ==============================================================================
[NUCLEAR_DEVICE]
type = THERMONUCLEAR
yield_kt = 500.0                     # 500 kilotons
fission_fraction = 0.50              # 50% fission, 50% fusion

# Burst geometry
burst_height = 500.0                 # 500 m height of burst (meters AGL)
location_x = 50000.0                 # Center of domain
location_y = 50000.0
location_z = 500.0                   # Height above ground

# Device characteristics
casing_mass = 5000.0                 # kg
efficiency = 0.25                    # 25% efficiency

# ==============================================================================
# Fireball and Thermal Source
# ==============================================================================
[FIREBALL]
model = BRODE                        # Brode fireball model

# Fireball parameters (empirical scaling)
# Maximum radius: R_max ≈ 66 * W^0.4 meters (W in kt)
# For 500 kt: ~550 m radius
max_radius = 550.0                   # meters
formation_time = 0.001               # 1 ms to max radius

# Temperature evolution
initial_temperature = 1.0e8          # 100 million K (X-ray domain)
peak_surface_temperature = 8000.0    # K at maximum size
cooling_time = 10.0                  # seconds to cool

# Thermal radiation pulse
thermal_pulse_duration = 2.5         # seconds
thermal_fraction = 0.35              # 35% of yield as thermal

# Optical properties
emissivity = 0.95
thermal_radiation_model = PLANCK_GRAY

# Second maximum (for high-yield devices)
enable_double_flash = true
first_minimum_time = 0.01            # seconds
second_maximum_time = 0.5

# ==============================================================================
# Atmospheric Model
# ==============================================================================
[ATMOSPHERE]
model = US_STANDARD_1976

# Domain extends from ground to upper atmosphere
ground_level = 0.0
top_of_domain = 100000.0             # 100 km (includes ionosphere)

# Layer structure
num_layers = 50
layer_type = EXPONENTIAL             # Exponential density decrease

# Standard atmosphere parameters at sea level
sea_level_pressure = 101325.0        # Pa
sea_level_temperature = 288.15       # K (15°C)
sea_level_density = 1.225            # kg/m³

# Lapse rates (standard atmosphere)
troposphere_lapse_rate = -0.0065     # K/m
stratosphere_lapse_rate = 0.001      # K/m
tropopause_height = 11000.0          # m
stratopause_height = 50000.0         # m

# Composition
mean_molecular_weight = 28.97        # g/mol
gamma = 1.4                          # Ratio of specific heats
gas_constant = 287.05                # J/kg·K

# Wind profile (optional - can add wind effects)
enable_wind = false
surface_wind_speed = 0.0
wind_direction = 0.0

# Humidity and clouds
relative_humidity = 0.50
cloud_layer = false

# ==============================================================================
# Atmospheric Shock Wave
# ==============================================================================
[BLAST_WAVE]
model = SEDOV_TAYLOR                 # Self-similar blast wave

# Initial conditions
initial_overpressure = 1.0e12        # Pa (at fireball surface)
shock_velocity = 30000.0             # m/s initial

# Shock physics
equation_of_state = IDEAL_GAS
gamma_effective = 1.4
include_real_gas_effects = true
high_temperature_dissociation = true

# Ground reflection (Mach stem formation)
enable_ground_reflection = true
ground_reflection_factor = 1.8       # Pressure enhancement

# Positive phase parameters
positive_phase_duration_scaling = GLASSTONE_DOLAN

# Negative phase
include_negative_phase = true

# Precursor effects
enable_thermal_precursor = true
precursor_type = THERMAL_LAYER

# Dust and debris
enable_debris_loading = true
debris_mass_fraction = 0.1

# ==============================================================================
# Radiation Transport
# ==============================================================================
[RADIATION_TRANSPORT]
enabled = true
method = MONTE_CARLO                 # Monte Carlo transport
num_particles = 10000000             # 10 million particles

# Prompt radiation (gamma and neutron)
[RADIATION_TRANSPORT.PROMPT]
enabled = true

# Gamma rays
gamma_yield_fraction = 0.005         # 0.5% of yield as prompt gamma
gamma_spectrum = FISSION_SPECTRUM
mean_gamma_energy = 1.0              # MeV
gamma_attenuation_model = EXPONENTIAL

# Neutrons
neutron_yield_fraction = 0.003
neutron_spectrum = FISSION_WATT
mean_neutron_energy = 2.0            # MeV
include_neutron_scattering = true
include_neutron_capture = true

# X-rays (absorbed in atmosphere, creates fireball)
xray_yield_fraction = 0.75           # Most energy initially as X-rays
xray_absorption_altitude = 10000.0   # Absorbed below ~10 km

[RADIATION_TRANSPORT.DELAYED]
# Delayed radiation from fallout
enabled = true
fission_product_model = ENGLAND_RIDER

# Decay chains
include_decay_chains = true
significant_isotopes = I-131, Cs-137, Sr-90, Xe-133, Ba-140

# Activity calculation
activity_model = WAY_WIGNER          # t^(-1.2) decay law

[RADIATION_TRANSPORT.FALLOUT]
enabled = true
particle_model = LOGNORMAL
median_particle_size = 100.0         # micrometers
geometric_std_dev = 2.5

# Fallout deposition
deposition_model = HOTSPOT           # HOTSPOT/NARAC model
gravitational_settling = true
dry_deposition = true
wet_deposition = false               # No rain

# Cloud rise parameters
stabilization_height = 15000.0       # m (mushroom cloud top)
cloud_rise_time = 300.0              # seconds

# Ground contamination output
output_contamination_map = true

# ==============================================================================
# Electromagnetic Pulse (EMP)
# ==============================================================================
[ELECTROMAGNETIC_PULSE]
enabled = true

# EMP source region
source_mechanism = COMPTON_CURRENT   # Compton electrons in atmosphere

# Three components of EMP
[EMP.E1]
# Early-time EMP (gamma-induced Compton current)
enabled = true
pulse_type = FAST
rise_time = 2.5e-9                   # 2.5 nanoseconds
decay_time = 1.0e-6                  # 1 microsecond
peak_field = 50000.0                 # V/m at 1 km

# Gamma source parameters
gamma_emission_time = 100.0e-9       # 100 ns gamma pulse
gamma_fluence = 1.0e13               # photons/m² at source

# Compton electron parameters
compton_electron_energy = 1.0        # MeV mean energy
geomagnetic_field = 50.0e-6          # Tesla (Earth's field)
geomagnetic_dip = 60.0               # degrees

# Source altitude effects
source_region_altitude = 20000.0     # m (Compton electrons created)
atmosphere_conductivity_profile = EXPONENTIAL

[EMP.E2]
# Intermediate-time EMP (scattered gamma)
enabled = true
pulse_type = INTERMEDIATE
rise_time = 1.0e-6                   # 1 microsecond
duration = 1.0e-3                    # 1 millisecond
peak_field = 1000.0                  # V/m

[EMP.E3]
# Late-time EMP (MHD-EMP from fireball expansion)
enabled = true
pulse_type = SLOW
rise_time = 0.1                      # 100 ms
duration = 100.0                     # 100 seconds
peak_field = 10.0                    # V/m

# Heave and magnetic field distortion
fireball_conductivity = 1.0e6        # S/m (ionized plasma)
magnetic_field_distortion = true

# Ground effects
[EMP.GROUND_EFFECTS]
ground_conductivity = 0.01           # S/m (typical soil)
enable_ground_wave = true
enable_sky_wave = true
ionosphere_reflection = true

# Infrastructure coupling
enable_line_coupling = true
power_line_length = 10000.0          # m (typical)
induced_current_model = TRANSMISSION_LINE

# Output fields
output_electric_field = true
output_magnetic_field = true
output_induced_current = true

# ==============================================================================
# Ionospheric Effects
# ==============================================================================
[IONOSPHERE]
enabled = true

# Ionosphere layers
D_layer_altitude = 60000.0           # 60 km
E_layer_altitude = 100000.0          # 100 km (outside domain)
F_layer_altitude = 300000.0          # 300 km (outside domain)

# Background electron density profile
background_model = IRI               # International Reference Ionosphere
daytime = true

# X-ray ionization enhancement
xray_ionization = true
enhanced_ionization_duration = 3600.0  # 1 hour

# Blackout effects
compute_radio_blackout = true
frequency_cutoff = 30.0e6            # Hz (HF cutoff)

# ==============================================================================
# Grid Configuration
# ==============================================================================
[GRID]
# Large domain for atmosphere and ground
nx = 400
ny = 400
nz = 200

# Domain: 100 km × 100 km × 100 km
Lx = 100000.0
Ly = 100000.0
Lz = 100000.0                        # 50 km ground + 100 km atmosphere

# Origin
origin_x = 0.0
origin_y = 0.0
origin_z = -50000.0                  # 50 km below, 100 km above ground

# Multi-domain mesh
use_multidomain = true

# Ground domain
[GRID.GROUND]
z_min = -50000.0
z_max = 0.0
nz = 50
material = SOLID

# Atmosphere domain
[GRID.ATMOSPHERE]
z_min = 0.0
z_max = 100000.0
nz = 150
material = GAS

# Adaptive refinement
[amr]
enabled = true
method = plex_refine

[amr.criterion]
type = combined
weight_shock = 1.0
weight_temperature = 0.5
weight_radiation = 0.3

[amr.limits]
max_refinement_level = 5
max_cells = 20000000
min_cell_size = 5.0

[amr.features]
buffer_layers = 3

# High resolution at burst point
[amr.features.burst]
x = 50000.0
y = 50000.0
z = 500.0
radius = 5000.0
level = 5

# Refinement at ground zero
[amr.features.ground_zero]
x = 50000.0
y = 50000.0
z = 0.0
radius = 10000.0
level = 4

# ==============================================================================
# Ground Material Properties
# ==============================================================================
[ROCK]
name = ALLUVIUM
constitutive_model = ELASTOPLASTIC_MC

# Alluvial soil properties
youngs_modulus = 500.0e6             # 500 MPa (soft soil)
poisson_ratio = 0.35
density = 1800.0                     # kg/m³

p_wave_velocity = 500.0              # m/s (very slow)
s_wave_velocity = 250.0

# Mohr-Coulomb plasticity
failure_criterion = MOHR_COULOMB
cohesion = 50.0e3                    # 50 kPa
friction_angle = 30.0                # degrees
tensile_strength = 10.0e3            # 10 kPa

# Crater formation
enable_crater_formation = true
excavation_model = HOLSAPPLE         # Holsapple scaling laws

# ==============================================================================
# Coupled Ground Response
# ==============================================================================
[GROUND_COUPLING]
# Air-ground interface
coupling_type = IMPEDANCE_MATCHING
surface_reflection = true

# Ground shock from air blast
air_blast_ground_coupling = true
coupling_factor = 0.01               # ~1% of overpressure couples to ground

# Seismic wave generation
seismic_source_type = DISTRIBUTED
source_area_radius = 5000.0          # m radius of loading

# Crater
crater_model = NORDYKE               # Nordyke scaling
scaled_depth = 0.0                   # Surface burst
apparent_crater_depth = 50.0         # m (estimated)
apparent_crater_radius = 300.0       # m (estimated)

# Ground motion
compute_ground_motion = true
surface_wave_generation = true

# ==============================================================================
# Initial Conditions
# ==============================================================================
[IC1]
field = PRESSURE_ATMOSPHERE
distribution = EXPONENTIAL
reference_value = 101325.0           # Pa at sea level
scale_height = 8500.0                # m

[IC2]
field = TEMPERATURE_ATMOSPHERE
distribution = PROFILE
profile_type = STANDARD_ATMOSPHERE

[IC3]
field = DENSITY_ATMOSPHERE
distribution = EXPONENTIAL
reference_value = 1.225              # kg/m³ at sea level
scale_height = 8500.0

[IC4]
# Ground at rest
field = DISPLACEMENT
distribution = UNIFORM
value = 0.0

[IC5]
# Initial temperature field
field = TEMPERATURE
distribution = GRADIENT
value = 288.15
gradient = 0.0, 0.0, -0.0065         # Lapse rate (atmosphere)

# ==============================================================================
# Boundary Conditions
# ==============================================================================
[BC1]
# Non-reflecting atmospheric boundaries
type = ABSORBING
location = XMIN, XMAX, YMIN, YMAX
field = ALL
absorbing_type = CHARACTERISTIC

[BC2]
# Top of atmosphere (outflow)
type = OUTFLOW
location = ZMAX
field = ALL

[BC3]
# Ground surface (coupled to atmosphere)
type = INTERFACE
location = GROUND_SURFACE
field = ALL
interface_type = ATMOSPHERE_GROUND

[BC4]
# Bottom of ground domain
type = ABSORBING
location = ZMIN
field = DISPLACEMENT
absorbing_type = PML
pml_layers = 20

# ==============================================================================
# Receivers and Stations
# ==============================================================================
[RECEIVERS]
output_format = HDF5
sampling_rate = 1000.0               # 1 kHz

# Pressure/overpressure sensors
[RECEIVER_ARRAY_PRESSURE]
type = LINE
start = 50000.0, 50000.0, 2.0
end = 100000.0, 50000.0, 2.0
num_stations = 50
fields = pressure, overpressure, temperature, velocity

# Ground motion seismometers
[RECEIVER_ARRAY_SEISMIC]
type = LINE
start = 50000.0, 50000.0, -1.0
end = 100000.0, 50000.0, -1.0
num_stations = 50
fields = displacement, velocity, acceleration

# Radiation detectors
[RECEIVER_ARRAY_RADIATION]
type = GRID
x_range = 45000.0, 75000.0
y_range = 45000.0, 75000.0
z = 1.0
nx = 10
ny = 10
fields = gamma_dose_rate, neutron_flux, total_dose

# EMP field sensors
[RECEIVER_ARRAY_EMP]
type = LINE
start = 50000.0, 50000.0, 10.0
end = 150000.0, 50000.0, 10.0
num_stations = 20
fields = electric_field_x, electric_field_y, electric_field_z, magnetic_field

# Individual key stations
[RECEIVER1]
name = GZ_SURFACE
location = 50000.0, 50000.0, 1.0
fields = ALL

[RECEIVER2]
name = 1KM_RANGE
location = 51000.0, 50000.0, 1.0
fields = ALL

[RECEIVER3]
name = 5KM_RANGE
location = 55000.0, 50000.0, 1.0
fields = ALL

[RECEIVER4]
name = 10KM_RANGE
location = 60000.0, 50000.0, 1.0
fields = ALL

[RECEIVER5]
name = 20KM_RANGE
location = 70000.0, 50000.0, 1.0
fields = ALL

# ==============================================================================
# Output Configuration
# ==============================================================================
[OUTPUT]
format = HDF5
path = output/atmospheric_nuclear

# Atmospheric fields
save_pressure = true
save_temperature = true
save_density = true
save_velocity = true

# Ground fields
save_displacement = true
save_ground_velocity = true
save_stress = true

# Radiation fields
save_dose_rate = true
save_accumulated_dose = true
save_contamination = true

# EMP fields
save_electric_field = true
save_magnetic_field = true
save_induced_current = true

# Frequencies
volume_output_frequency = 1000
surface_output_frequency = 100

# Special outputs
save_shock_front = true
save_fireball_contour = true
save_fallout_trajectory = true

# Visualization helpers
save_overpressure_contours = true
overpressure_levels = 0.01, 0.03, 0.07, 0.14, 0.35, 0.7, 1.4, 3.5  # Bar

# Movies
save_animation_frames = true
animation_frame_interval = 10

# ==============================================================================
# Analysis
# ==============================================================================
[ANALYSIS]
# Damage assessment
compute_blast_damage = true
damage_categories = light, moderate, severe, total
overpressure_thresholds = 3.5, 14, 35, 140    # kPa

# Thermal damage
compute_thermal_damage = true
thermal_fluence_thresholds = 125, 335, 670, 1675  # kJ/m² (burns)

# Radiation effects
compute_radiation_effects = true
dose_thresholds = 0.01, 0.1, 1.0, 10.0  # Sv

# EMP effects
compute_emp_effects = true
field_thresholds = 1000, 5000, 25000, 50000  # V/m

# Combined effects
compute_combined_effects = true
output_damage_map = true

# Seismic analysis
compute_seismic_magnitude = true
compute_ground_motion_parameters = true
compute_response_spectra = true

# Atmospheric effects
compute_mushroom_cloud = true
compute_fallout_pattern = true
compute_thermal_plume = true
