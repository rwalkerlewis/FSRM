# PyLith-Style Dynamic Fault Configuration
# 
# This configuration demonstrates a dynamic (spontaneous rupture) fault
# with slip-weakening or rate-and-state friction.
# Based on PyLith's FaultCohesiveDyn implementation.
#
# Reference: SCEC/USGS benchmark problem TPV5
# (3D spontaneous rupture benchmark with slip-weakening friction)
#
# Key features:
# - Spontaneous rupture propagation governed by friction
# - Slip-weakening friction (standard SCEC benchmark)
# - Alternative: rate-and-state friction
# - Nucleation via shear stress perturbation
# - Cohesive cell representation with Lagrange multipliers

[SIMULATION]
name = pylith_dynamic_strike_slip
physics_type = ELASTODYNAMICS
start_time = 0.0
end_time = 12.0
dt_initial = 0.002
dt_min = 0.0001
dt_max = 0.005

# Enable fault modeling
enable_faults = true
fault_implementation = PYLITH_COHESIVE

# Time integration (explicit for dynamics)
time_integrator = CENTRAL_DIFFERENCE
lumped_mass = true
rtol = 1.0e-8
atol = 1.0e-12

# CFL condition check
cfl_limit = 0.5

[GRID]
# Domain: 60 km × 60 km × 32 km
# Match SCEC TPV5 geometry
nx = 301
ny = 301
nz = 161
Lx = 60000.0
Ly = 60000.0
Lz = 32000.0
origin_x = -30000.0
origin_y = -30000.0
origin_z = -32000.0

[MATERIAL]
# TPV5 material properties
constitutive_model = LINEAR_ELASTIC
density = 2670.0
shear_modulus = 32.04e9
p_wave_velocity = 6000.0
s_wave_velocity = 3464.0
youngs_modulus = 80.1e9
poisson_ratio = 0.25

#==============================================================================
# PYLITH-STYLE DYNAMIC FAULT
#==============================================================================
[FAULT_DYNAMIC]
name = main_fault_dynamic
fault_type = dynamic
implementation = pylith_cohesive

# Fault geometry (TPV5-style)
# Vertical strike-slip fault
x = 0.0
y = 0.0
z = -7500.0
strike = 0.0
dip = 90.0
length = 30000.0
width = 15000.0

# Fault mesh (finer near nucleation)
fault_mesh_nx = 301
fault_mesh_nz = 151

# Cohesive cell configuration
use_cohesive_cells = true
use_lagrange_multipliers = true

#------------------------------------------------------------------------------
# FRICTION MODEL: SLIP-WEAKENING (TPV5 standard)
#------------------------------------------------------------------------------
friction_model = slip_weakening

# Friction parameters (SCEC TPV5)
static_friction = 0.677
dynamic_friction = 0.525
critical_slip_distance = 0.40

# Optional cohesion
cohesion = 0.0

# Strength drop ratio: (μ_s - μ_d) / μ_s = 0.224

#------------------------------------------------------------------------------
# ALTERNATIVE: RATE-AND-STATE FRICTION (Aging Law)
#------------------------------------------------------------------------------
# friction_model = rate_state_aging
# 
# # Rate-state parameters
# a = 0.008
# b = 0.012
# dc = 0.02
# f0 = 0.6
# v0 = 1.0e-6
# 
# # Initial state variable (time to next earthquake)
# initial_state = 1.0e6
#
# # Linearization threshold for quasi-static creep
# linear_threshold = 1.0e-12

#------------------------------------------------------------------------------
# ALTERNATIVE: RATE-AND-STATE FRICTION (Slip Law)
#------------------------------------------------------------------------------
# friction_model = rate_state_slip
# a = 0.01
# b = 0.015
# dc = 0.01
# f0 = 0.6
# v0 = 1.0e-6

#------------------------------------------------------------------------------
# INITIAL STRESS STATE
#------------------------------------------------------------------------------
# Initial tractions on fault plane
initial_traction_type = uniform

# TPV5 initial stress state
# τ₀ = 70 MPa (shear), σₙ = -120 MPa (normal compression)
initial_traction_shear_ll = 70.0e6
initial_traction_shear_ud = 0.0
initial_traction_normal = -120.0e6

# Compute stress ratio
# τ₀/τ_strength = 70/(0.677×120) = 0.862 (close to failure)

# Alternative: depth-dependent stress from file
# initial_traction_type = from_file
# initial_traction_file = initial_stress.dat

#------------------------------------------------------------------------------
# NUCLEATION (Shear stress perturbation)
#------------------------------------------------------------------------------
# Gaussian shear stress perturbation to nucleate rupture
nucleation_type = traction_perturbation
perturbation_type = gaussian

# Perturbation location (hypocenter)
perturbation_center_x = 0.0
perturbation_center_y = 0.0
perturbation_center_z = -7500.0

# Perturbation amplitude and shape
# Must exceed yield strength: Δτ + τ₀ > μ_s × σₙ
# Need: Δτ > 0.677 × 120 - 70 = 11.24 MPa
perturbation_amplitude = 11.6e6
perturbation_width = 3000.0
perturbation_duration = 1.0

# Time function for perturbation (smooth ramp)
perturbation_time_fn = cosine_ramp

# Alternative: forced rupture (prescribe slip in nucleation zone)
# nucleation_type = forced_rupture
# nucleation_velocity = 1000.0
# nucleation_radius = 1500.0

#------------------------------------------------------------------------------
# OUTPUT CONFIGURATION
#------------------------------------------------------------------------------
[FAULT_OUTPUT]
format = VTK
path = output/pylith_dynamic
frequency = 50

# Output fields
fields = slip, slip_rate, traction, state_variable

# Time series at specific points
time_series_points = fault_time_series.dat
time_series_frequency = 1
time_series_fields = slip, slip_rate, traction_normal, traction_shear

# Rupture front tracking
track_rupture_front = true
rupture_threshold = 0.001
rupture_front_file = output/pylith_dynamic/rupture_front.dat

#==============================================================================
# BOUNDARY CONDITIONS
#==============================================================================
[BC_ABSORBING]
# Absorbing boundaries (CPML or Stacey)
location = XMIN, XMAX, YMIN, YMAX, ZMIN
type = CPML
cpml_thickness = 10
cpml_damping = 1.0

[BC_SURFACE]
# Free surface
location = ZMAX
type = FREE_SURFACE

#==============================================================================
# INITIAL CONDITIONS
#==============================================================================
[IC]
displacement = 0.0, 0.0, 0.0
velocity = 0.0, 0.0, 0.0

# Note: Regional stress is applied through fault initial traction,
# not as IC on the volume. For fully consistent regional stress,
# use prestress field.

#==============================================================================
# VOLUME OUTPUT
#==============================================================================
[OUTPUT]
format = VTK
path = output/pylith_dynamic
frequency = 100

displacement = true
velocity = true
stress = false
strain = false

# Surface output (for ground motion)
surface_output = true
surface_path = output/pylith_dynamic/surface
surface_frequency = 20
surface_fields = displacement, velocity, acceleration

# Receiver time series (seismograms)
receivers = receivers.dat
receiver_output_format = ASCII
receiver_sample_rate = 0.01
receiver_fields = displacement, velocity, acceleration

#==============================================================================
# ANALYSIS
#==============================================================================
[ANALYSIS]
# Energy balance
compute_energy = true
energy_output_frequency = 10
energy_file = output/pylith_dynamic/energy.dat

# Seismicity catalog
output_catalog = true
catalog_file = output/pylith_dynamic/event_catalog.csv

# Slip statistics
compute_slip_statistics = true
statistics_file = output/pylith_dynamic/slip_statistics.dat

# Ground motion metrics (PGV, PGA, SA)
compute_ground_motion = true
ground_motion_file = output/pylith_dynamic/ground_motion.dat

#==============================================================================
# SCEC TPV5 COMPARISON POINTS
# On-fault time series at specific locations
#==============================================================================
# TPV5 comparison points (on fault, relative to hypocenter):
# Point 1: Along strike +7.5 km
# Point 2: Along strike -7.5 km  
# Point 3: Down dip +6.0 km
# 
# Format of fault_time_series.dat:
# x y z [name]
# 0.0 7500.0 -7500.0 fltst075
# 0.0 -7500.0 -7500.0 fltst-75
# 0.0 0.0 -13500.0 fltdp060
