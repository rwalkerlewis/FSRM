# ============================================================================
# SCEC TPV104: Rate-and-State with Strong Velocity Weakening
# ============================================================================
# Tests extreme velocity weakening behavior
# Reference: http://scec.org/cvws/download/TPV104_Description_v03.pdf
# ============================================================================

[SIMULATION]
name = SCEC_TPV104
description = "Rate-and-state with strong velocity weakening"

start_time = 0.0
end_time = 15.0
dt_initial = 0.00005               # Very small timestep (stiff problem)
dt_min = 1e-9
dt_max = 0.0005
adaptive_timestepping = true

output_frequency = 100
output_format = HDF5
output_directory = output/tpv104

# Numerical method
use_discontinuous_galerkin = true
dg_order = 4
use_ader_time_integration = true
enable_local_time_stepping = true
lts_rate = 2

enable_elastodynamics = true
enable_dynamic_rupture = true

use_gpu = true

[GRID]
nx = 400                           # Need finer mesh
ny = 1
nz = 200
Lx = 48000.0
Ly = 100.0
Lz = 20000.0

[ROCK]
youngs_modulus = 32.04e9
poisson_ratio = 0.25
density = 2670.0
p_wave_velocity = 6000.0
s_wave_velocity = 3464.0

enable_attenuation = false

[FAULT1]
type = PLANAR_VERTICAL
strike = 0.0
dip = 90.0
x_center = 0.0
y_center = 0.0
z_center = -8660.0
length = 48000.0
width = 17320.0

# Rate-and-state with STRONG VELOCITY WEAKENING
friction_law = RATE_STATE_STRONG_VW
rs_a = 0.008                       # Direct effect
rs_b = 0.012                       # Evolution effect
rs_L = 0.02                        # State evolution distance
rs_f0 = 0.6                        # Reference friction
rs_V0 = 1.0e-6                     # Reference velocity

# Additional parameters for strong VW
rs_V_w = 0.1                       # Weakening velocity [m/s]
rs_mu_w = 0.2                      # Weakening friction coefficient

# This gives very strong weakening at high slip rates!
# μ can drop from 0.6 to 0.2

# Initial state
rs_initial_slip_rate_strike = 0.0
rs_initial_slip_rate_dip = 0.0
rs_initial_state_variable = 2.0e7

# Initial stress
initial_stress_xx = 0.0
initial_stress_yy = -120.0e6
initial_stress_zz = 0.0
initial_stress_xy = 75.0e6
initial_stress_xz = 0.0
initial_stress_yz = 0.0

# Nucleation
nucleation_type = SPATIAL_PATCH
nucleation_x_center = 0.0
nucleation_z_center = -10000.0
nucleation_radius = 3000.0
nucleation_overstress = 1.32

use_split_nodes = true
split_node_method = PENALTY

[STRONG_VELOCITY_WEAKENING]
# TPV104 friction law:
# f(V, ψ) = a × asinh[(V / (2 V_0)) × exp(ψ / a)]
#
# State evolution (slip law with strong weakening):
# dψ/dt = -(V / L) × [ψ - a ln(2 V_0 / V × sinh(μ_ss(V) / a))]
#
# Steady-state friction:
# μ_ss(V) = μ_w + (f_0 - (b-a) ln(V/V_0) - μ_w) / [1 + (V/V_w)^8]^(1/8)
#
# At low V: μ_ss → f_0 - (b-a) ln(V/V_0) (normal rate-state)
# At high V: μ_ss → μ_w (strong weakening)
#
# The (V/V_w)^8 term gives rapid transition

# Effective parameters
enable_strong_weakening = true
weakening_transition_velocity = 0.1     # V_w [m/s]
weakening_friction_floor = 0.2          # μ_w
weakening_exponent = 8.0                # Controls sharpness

[NUMERICAL_SETTINGS]
# TPV104 is numerically challenging
# Very stiff ODEs due to strong weakening

# Solver tolerances
nonlinear_rtol = 1e-8
nonlinear_atol = 1e-10
nonlinear_max_iterations = 50

# State variable constraints
state_variable_min = 1e-10         # Prevent negative θ
state_variable_max = 1e10          # Prevent overflow

# Slip rate limits
slip_rate_min = 1e-20              # Essentially zero
slip_rate_max = 10.0               # Cap at 10 m/s

# Adaptive time stepping
use_adaptive_dt = true
dt_safety_factor = 0.5
dt_increase_factor = 1.2
dt_decrease_factor = 0.5

[BC1]
type = FREE_SURFACE
location = ZMAX

[BC2]
type = ABSORBING
location = XMIN,XMAX,YMIN,YMAX,ZMIN
absorbing_method = PML

[OUTPUT]
output_fault_data = true
fault_output_fields = slip,slip_rate,shear_stress,normal_stress,rupture_time,friction_coefficient,state_variable,steady_state_friction
fault_output_frequency = 10

volume_output_fields = velocity,displacement
volume_output_frequency = 100

enable_receivers = true
receiver_file = benchmarks/receivers_tpv104.txt

[VERIFICATION]
enable_verification = true
reference_solution_dir = benchmarks/reference/tpv104
verification_tolerance = 0.10       # 10% (more variable behavior)

verify_rupture_time = true
verify_slip_distribution = true
verify_extreme_weakening = true
verify_high_slip_rates = true

[ANALYSIS]
compute_rupture_velocity = true
analyze_extreme_weakening = true
compute_slip_rate_history = true
track_friction_evolution = true

# TPV104-specific
measure_weakening_magnitude = true
compute_stress_drop = true
analyze_energy_efficiency = true

# Weakening analysis
plot_friction_vs_slip_rate = true
compute_weakening_distance = true
measure_peak_slip_rate = true

[NOTES]
# TPV104 Key Features:
# - Extreme velocity weakening
# - Friction drops from 0.6 to 0.2
# - Very high slip rates (>1 m/s)
# - Fast rupture velocity (~0.9 × V_s)
# - Numerically challenging (stiff)
#
# Expected Results:
# - Very fast rupture
# - High slip rates (up to several m/s)
# - Dramatic friction drop
# - Apparent friction ~0.2-0.3
# - Large stress drop
# - Efficient energy radiation
#
# Physics:
# - Strong VW mimics thermal pressurization effects
# - Without solving diffusion equations
# - Captures essence of TP weakening
# - More efficient computationally
#
# Numerical Challenges:
# - Very stiff ODEs
# - Requires small time steps
# - Sensitive to initial conditions
# - Can have convergence issues
# - Need robust solver
#
# Comparison with TPV101:
# - TPV101: Normal rate-state (mild weakening)
# - TPV104: Strong VW (extreme weakening)
# - TPV104: Much faster rupture
# - TPV104: Higher slip rates
# - TPV104: More challenging numerically
#
# Comparison with TPV34:
# - TPV34: Full TP with diffusion
# - TPV104: TP-like without diffusion
# - TPV104: More efficient
# - TPV104: Less physical detail
# - Both give similar macroscopic behavior
#
# Implementation Notes:
# - Use implicit time integration
# - Constrain state variable (prevent negative)
# - Limit slip rate (prevent overflow)
# - Adaptive time stepping essential
# - May need line search in Newton solver
