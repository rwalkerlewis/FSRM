# ============================================================================
# SCEC TPV13: Branched Fault with Off-Fault Plasticity
# ============================================================================
# Tests coupled elastoplastic deformation during dynamic rupture
# Reference: http://scec.org/cvws/download/TPV14_15_Description_v08.pdf
# ============================================================================

[SIMULATION]
name = SCEC_TPV13
description = "Right-lateral strike-slip with 30-degree branch and plasticity"

start_time = 0.0
end_time = 12.0
dt_initial = 0.0005                # Smaller timestep for plasticity
dt_min = 1e-7
dt_max = 0.005

output_frequency = 100
output_format = HDF5
output_directory = output/tpv13

# Numerical method
use_discontinuous_galerkin = true
dg_order = 3                       # O3 is good balance for plasticity
use_ader_time_integration = true
enable_local_time_stepping = true
lts_rate = 2

# Physics
enable_elastodynamics = true
enable_dynamic_rupture = true
enable_plasticity = true           # KEY FEATURE for TPV13

use_gpu = true

[GRID]
# Need fine mesh for plasticity resolution
use_unstructured = true
mesh_file = meshes/tpv13_branched.msh

# Mesh requirements:
# - Fine near faults (~50-100 m)
# - Coarser far from faults (~500 m)
# - Transition zones with LTS

[ROCK]
# Homogeneous elastic-plastic material
youngs_modulus = 32.04e9
poisson_ratio = 0.25
density = 2670.0
p_wave_velocity = 6000.0
s_wave_velocity = 3464.0

# Plasticity parameters (Drucker-Prager)
enable_plasticity = true
yield_criterion = DRUCKER_PRAGER
friction_angle = 31.5              # degrees (from SCEC specs)
cohesion = 0.0                     # No cohesion
dilation_angle = 0.0               # No dilation (avoid volumetric issues)
tensile_strength = 1.0e99          # Effectively infinite (no tension)

# No hardening for TPV13
hardening_law = NONE

# Optional: strain softening for more realistic damage
# hardening_law = STRAIN_SOFTENING
# softening_modulus = -10e9
# residual_friction_angle = 20.0

# Attenuation (optional)
enable_attenuation = false

[FAULT_MAIN]
# Main fault: vertical right-lateral strike-slip
name = main_fault
type = PLANAR_VERTICAL
strike = 0.0                       # N-S fault
dip = 90.0                         # Vertical
x_center = 0.0
y_center = 0.0
z_center = -7500.0                 # 7.5 km depth
length = 30000.0                   # 30 km along strike
width = 15000.0                    # 15 km depth extent

# Linear slip-weakening friction
friction_law = LINEAR_SLIP_WEAKENING
mu_s = 0.677
mu_d = 0.525
d_c = 0.40
cohesion = 0.0

# Initial stress (right-lateral)
initial_stress_xx = 0.0
initial_stress_yy = -120.0e6       # Pa
initial_stress_zz = 0.0
initial_stress_xy = 70.0e6         # Shear stress (right-lateral)
initial_stress_xz = 0.0
initial_stress_yz = 0.0

# Nucleation patch
nucleation_type = SPATIAL_PATCH
nucleation_x_center = 0.0
nucleation_y_center = -12000.0     # 12 km from branch
nucleation_z_center = -7500.0
nucleation_radius = 3000.0
nucleation_overstress_xy = 11.6e6  # Additional shear (total 81.6 MPa)

use_split_nodes = true
split_node_method = PENALTY

[FAULT_BRANCH]
# Branch fault: 30° from main fault (dips North)
name = branch_fault
type = PLANAR_DIPPING
strike = 0.0
dip = 60.0                         # 30° from vertical = 60° dip
x_center = 0.0
y_center = 8660.0                  # 15 km * sin(30°) = offset
z_center = -7500.0
length = 15000.0
width = 15000.0

# Branch point at origin (y=0)
branch_point_y = 0.0

# Same friction law
friction_law = LINEAR_SLIP_WEAKENING
mu_s = 0.677
mu_d = 0.525
d_c = 0.40
cohesion = 0.0

# Rotated stress on branch (see stressrotation3D)
# Rotate 30° clockwise around z-axis
initial_stress_xx = 30.62e6
initial_stress_yy = -150.62e6
initial_stress_zz = 0.0
initial_stress_xy = -16.96e6       # Rotated shear
initial_stress_xz = 0.0
initial_stress_yz = 0.0

use_split_nodes = true
split_node_method = PENALTY

[BC1]
type = FREE_SURFACE
location = ZMAX

[BC2]
type = ABSORBING
location = XMIN,XMAX,YMIN,YMAX,ZMIN
absorbing_method = PML

[OUTPUT]
# Fault output
output_fault_data = true
fault_output_fields = slip,slip_rate,shear_stress,normal_stress,rupture_time
fault_output_frequency = 1

# Volume output with plasticity
volume_output_fields = velocity,displacement,stress,plastic_strain,accumulated_plastic_strain,yield_function
volume_output_frequency = 50

# Plasticity-specific output
output_plasticity_data = true
plasticity_output_fields = plastic_strain,accumulated_plastic_strain,yield_function,damage
plasticity_output_frequency = 50

# Receivers
enable_receivers = true
receiver_file = benchmarks/receivers_tpv13.txt

[VERIFICATION]
enable_verification = true
reference_solution_dir = benchmarks/reference/tpv13
verification_tolerance = 0.10      # 10% (plasticity is more variable)

verify_rupture_time = true
verify_slip_distribution = true
verify_plastic_zone = true
verify_energy_balance = true

[ANALYSIS]
# TPV13-specific analysis
compute_rupture_velocity = true
compute_branch_activation = true
analyze_plastic_zone = true
compute_energy_partitioning = true

# Plastic zone analysis
track_plastic_volume = true
compute_plastic_strain_distribution = true
analyze_damage_zone_width = true

# Branch analysis
measure_branch_angle_effect = true
compute_rupture_jump_time = true

[PLASTICITY_ZONES]
# Expected plastic zones
# - Narrow bands along faults (~100-200 m wide)
# - Concentrated at branch point
# - Follows Coulomb criterion
# - Energy dissipation ~5-10% of total

expected_plastic_zone_width = 200.0    # meters
expected_plastic_strain_max = 0.01     # 1%

[NOTES]
# TPV13 Key Features:
# - Branched fault geometry
# - Off-fault plastic deformation (Drucker-Prager)
# - Energy partitioning between elastic waves, fracture, plasticity
# - Realistic earthquake damage zones
#
# Expected Results:
# - Rupture propagates on main fault
# - Branch may or may not activate (stress-dependent)
# - Plastic zone forms along faults (~100-200 m wide)
# - Plastic strain up to 1%
# - 5-10% of energy dissipated in plasticity
# - Reduced rupture velocity (~0.75 × V_s)
#
# Differences from TPV12:
# - TPV12: Elastic only
# - TPV13: Elastic-plastic
# - TPV13 has more energy dissipation
# - TPV13 has wider damage zone
#
# Plasticity Implementation Notes:
# - Drucker-Prager with φ=31.5° (from SCEC)
# - No cohesion (c=0)
# - No dilation (ψ=0)
# - Perfect plasticity (no hardening)
# - Return mapping algorithm
# - Consistent tangent for Newton convergence
